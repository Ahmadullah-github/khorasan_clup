<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        .dropzone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            position: relative;
        }
        .dropzone:hover, .dropzone.dragover {
            border-color: var(--color-primary-500);
            background: var(--color-primary-50);
        }
        [data-theme="dark"] .dropzone:hover, [data-theme="dark"] .dropzone.dragover {
            background: rgba(59, 130, 246, 0.1);
        }
        .dropzone-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .dropzone-icon {
            font-size: 2.5rem;
            color: var(--color-primary-500);
            margin-bottom: var(--space-2);
        }
        .dropzone-text {
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        .dropzone-hint {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin: 0;
        }
        .dropzone-preview {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-file {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        .preview-icon {
            font-size: 1.5rem;
            color: var(--color-success-500);
        }
        .preview-name {
            font-weight: var(--font-weight-medium);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .preview-remove {
            background: var(--color-danger-100);
            border: none;
            border-radius: var(--radius-full);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-danger-600);
            transition: all 0.2s;
        }
        .preview-remove:hover {
            background: var(--color-danger-500);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html">
            <span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>
            Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†
        </a>
        
        <ul class="navbar-nav-app">
            <li><a class="nav-link-app" href="index.html">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
            <li><a class="nav-link-app" href="students.html">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a></li>
            <li><a class="nav-link-app" href="coaches.html">Ù…Ø±Ø¨ÛŒØ§Ù†</a></li>
            <li><a class="nav-link-app active" href="expenses.html">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a></li>
            <li><a class="nav-link-app" href="rent.html">Ø§Ø¬Ø§Ø±Ù‡</a></li>
            <li><a class="nav-link-app" href="accounting.html">Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ</a></li>
            <li><a class="nav-link-app" href="reports.html">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a></li>
            <li id="adminNavItem" style="display: none;">
                <a class="nav-link-app" href="admin.html">Ù…Ø¯ÛŒØ±</a>
            </li>
        </ul>
        
        <div class="navbar-actions">
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons">
                    <span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span>
                    <span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span>
                </span>
                <span class="theme-switch-slider"></span>
            </button>
            <div class="navbar-user">
                <span class="navbar-user-icon"><i class="bi bi-person"></i></span>
                <span id="userName"></span>
            </div>
            <button class="navbar-logout" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
        
        <button class="navbar-mobile-toggle" id="mobileMenuToggle">
            <i class="bi bi-list"></i>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar-app" id="sidebar">
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="index.html" class="sidebar-nav-link">
                    <i class="bi bi-grid-1x2 sidebar-nav-icon"></i>
                    Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
            </div>
            
            <div class="sidebar-section-title">Ù…Ø¯ÛŒØ±ÛŒØª</div>
            
            <div class="sidebar-nav-item">
                <a href="students.html" class="sidebar-nav-link">
                    <i class="bi bi-people sidebar-nav-icon"></i>
                    Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="coaches.html" class="sidebar-nav-link">
                    <i class="bi bi-person-badge sidebar-nav-icon"></i>
                    Ù…Ø±Ø¨ÛŒØ§Ù†
                </a>
            </div>
            
            <div class="sidebar-section-title">Ù…Ø§Ù„ÛŒ</div>
            
            <div class="sidebar-nav-item">
                <a href="expenses.html" class="sidebar-nav-link active">
                    <i class="bi bi-cash-stack sidebar-nav-icon"></i>
                    Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="rent.html" class="sidebar-nav-link">
                    <i class="bi bi-house sidebar-nav-icon"></i>
                    Ø§Ø¬Ø§Ø±Ù‡
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="accounting.html" class="sidebar-nav-link">
                    <i class="bi bi-calculator sidebar-nav-icon"></i>
                    Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="reports.html" class="sidebar-nav-link">
                    <i class="bi bi-bar-chart sidebar-nav-icon"></i>
                    Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                </a>
            </div>
            
            <div class="sidebar-section-title">Ø³ÛŒØ³ØªÙ…</div>
            
            <div class="sidebar-nav-item" id="adminSidebarItem" style="display: none;">
                <a href="admin.html" class="sidebar-nav-link">
                    <i class="bi bi-gear sidebar-nav-icon"></i>
                    Ù…Ø¯ÛŒØ±
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link" onclick="logout()">
                    <i class="bi bi-box-arrow-right sidebar-nav-icon"></i>
                    Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container-app">
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Page Header -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="page-title mb-0">
                    <i class="bi bi-cash-stack me-2"></i>
                    Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                </h1>
                <button class="btn-app btn-app--primary" data-bs-toggle="modal" data-bs-target="#expenseModal">
                    <i class="bi bi-plus-lg"></i>
                    Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡
                </button>
            </div>
            
            <!-- Summary Card -->
            <div class="card-app mb-4 animate-slideUp" id="summaryCard" style="display: none;">
                <div class="card-app-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</span>
                            <strong class="text-danger fs-5 ms-2" id="totalExpenses">0 Ø§ÙØºØ§Ù†ÛŒ</strong>
                        </div>
                        <div>
                            <span class="text-muted">ØªØ¹Ø¯Ø§Ø¯:</span>
                            <strong class="ms-2" id="expenseCount">0</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses List -->
            <div class="card-app animate-slideUp">
                <div class="card-app-header">
                    <h2 class="card-app-title">
                        <i class="bi bi-list-ul"></i>
                        Ù„ÛŒØ³Øª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                    </h2>
                    <div class="d-flex gap-3 flex-wrap">
                        <select class="form-control-app form-select-app" id="categoryFilter" style="width: auto; min-width: 150px;">
                            <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
                            <option value="Rent">Ø§Ø¬Ø§Ø±Ù‡</option>
                            <option value="Equipment">ØªØ¬Ù‡ÛŒØ²Ø§Øª</option>
                            <option value="Taxes">Ù…Ø§Ù„ÛŒØ§Øª</option>
                            <option value="Services">Ø®Ø¯Ù…Ø§Øª</option>
                            <option value="Other">Ø³Ø§ÛŒØ±</option>
                        </select>
                        <div class="search-box-app">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" class="search-input" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
                        </div>
                    </div>
                </div>
                <div class="card-app-body p-0">
                    <div class="table-responsive">
                        <table class="table-app">
                            <thead>
                                <tr>
                                    <th>Ø¹Ù†ÙˆØ§Ù†</th>
                                    <th>Ø¯Ø³ØªÙ‡</th>
                                    <th>Ù…Ø¨Ù„Øº</th>
                                    <th>ØªØ§Ø±ÛŒØ®</th>
                                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <tr>
                                    <td colspan="5">
                                        <div class="text-center py-4">
                                            <div class="spinner-app mx-auto mb-3"></div>
                                            <div class="text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-app-footer" id="paginationContainer"></div>
            </div>
        </div>
    </main>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Expense Modal -->
    <div class="modal fade modal-app" id="expenseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i>
                        Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <div class="form-group">
                            <label class="form-label-app required">
                                <i class="bi bi-card-text"></i>
                                Ø¹Ù†ÙˆØ§Ù†
                            </label>
                            <input type="text" class="form-control-app" id="expenseTitle" required placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø²ÛŒÙ†Ù‡">
                        </div>
                        <div class="form-group">
                            <label class="form-label-app required">
                                <i class="bi bi-tag"></i>
                                Ø¯Ø³ØªÙ‡
                            </label>
                            <select class="form-control-app form-select-app" id="expenseCategory" required>
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                                <option value="Rent">Ø§Ø¬Ø§Ø±Ù‡</option>
                                <option value="Equipment">ØªØ¬Ù‡ÛŒØ²Ø§Øª</option>
                                <option value="Taxes">Ù…Ø§Ù„ÛŒØ§Øª</option>
                                <option value="Services">Ø®Ø¯Ù…Ø§Øª</option>
                                <option value="Other">Ø³Ø§ÛŒØ±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label-app required">
                                <i class="bi bi-cash"></i>
                                Ù…Ø¨Ù„Øº
                            </label>
                            <div class="input-group-app">
                                <span class="input-group-prepend">Ø§ÙØºØ§Ù†ÛŒ</span>
                                <input type="number" class="form-control-app" id="expenseAmount" min="0" step="0.01" required placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label-app required">
                                <i class="bi bi-calendar3"></i>
                                ØªØ§Ø±ÛŒØ® (Ø¬Ù„Ø§Ù„ÛŒ)
                            </label>
                            <input type="text" class="form-control-app" id="expenseDate" required placeholder="1404/01/01">
                            <input type="hidden" id="expenseDateAlt">
                        </div>
                        <div class="form-group">
                            <label class="form-label-app">
                                <i class="bi bi-receipt"></i>
                                Ø±Ø³ÛŒØ¯
                            </label>
                            <div class="dropzone" id="receiptDropzone">
                                <input type="file" class="dropzone-input" id="receiptUpload" accept="image/*,application/pdf">
                                <div class="dropzone-content" id="dropzoneContent">
                                    <i class="bi bi-cloud-arrow-up dropzone-icon"></i>
                                    <p class="dropzone-text">ÙØ§ÛŒÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                                    <p class="dropzone-hint">Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª (JPEG, PNG, PDF)</p>
                                </div>
                                <div class="dropzone-preview d-none" id="dropzonePreview">
                                    <div class="preview-file">
                                        <i class="bi bi-file-earmark-check preview-icon"></i>
                                        <span class="preview-name" id="previewFileName"></span>
                                        <button type="button" class="preview-remove" id="removeFile" title="Ø­Ø°Ù">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label-app">
                                <i class="bi bi-sticky"></i>
                                Ø¬Ø²Ø¦ÛŒØ§Øª
                            </label>
                            <textarea class="form-control-app" id="expenseDetails" rows="3" placeholder="Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø¶Ø§ÙÛŒ..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app--secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn-app btn-app--primary" id="submitBtn" form="expenseForm">
                        <span class="spinner-app spinner-app--sm d-none" id="btnSpinner"></span>
                        <span id="btnText">Ø°Ø®ÛŒØ±Ù‡</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.0.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/jalali.js"></script>
    <script>
        let currentPage = 1;
        let currentSearch = '';
        let currentCategory = '';
        let editingExpenseId = null;

        // Convert Persian/Dari numerals to ASCII
        function convertPersianToEnglishNumbers(str) {
            if (!str) return str;
            const persianNumbers = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            for (let i = 0; i < 10; i++) {
                str = str.replace(new RegExp(persianNumbers[i], 'g'), i.toString());
                str = str.replace(new RegExp(arabicNumbers[i], 'g'), i.toString());
            }
            return str;
        }

        // Check auth
        const user = checkAuth();
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.username;
            if (user.role === 'admin') {
                document.getElementById('adminNavItem').style.display = 'block';
                document.getElementById('adminSidebarItem').style.display = 'block';
            }
        }

        // Dropzone functionality
        const dropzone = document.getElementById('receiptDropzone');
        const fileInput = document.getElementById('receiptUpload');
        const dropzoneContent = document.getElementById('dropzoneContent');
        const dropzonePreview = document.getElementById('dropzonePreview');
        const previewFileName = document.getElementById('previewFileName');
        const removeFileBtn = document.getElementById('removeFile');

        function showFilePreview(file) {
            dropzoneContent.classList.add('d-none');
            dropzonePreview.classList.remove('d-none');
            previewFileName.textContent = file.name;
        }

        function clearFilePreview() {
            dropzoneContent.classList.remove('d-none');
            dropzonePreview.classList.add('d-none');
            fileInput.value = '';
        }

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                    // Create a new DataTransfer to set the file
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                    showFilePreview(file);
                } else {
                    notify._showSnackbar('ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ùˆ PDF Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯', 'warning');
                }
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                showFilePreview(e.target.files[0]);
            }
        });

        removeFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            clearFilePreview();
        });

        // Initialize date picker
        $(document).ready(function() {
            $('#expenseDate').persianDatepicker({
                observer: true,
                format: 'YYYY/MM/DD',
                altField: '#expenseDateAlt',
                altFormat: 'YYYY-MM-DD',
                onSelect: function(unix) {
                    // Manually set the alt field value in correct format with ASCII numbers
                    const pd = new persianDate(unix);
                    const formatted = pd.format('YYYY-MM-DD');
                    // Convert to ASCII numbers
                    const asciiFormatted = convertPersianToEnglishNumbers(formatted);
                    $('#expenseDateAlt').val(asciiFormatted);
                }
            });
        });

        // Category labels
        const categoryLabels = {
            'Rent': 'Ø§Ø¬Ø§Ø±Ù‡',
            'Equipment': 'ØªØ¬Ù‡ÛŒØ²Ø§Øª',
            'Taxes': 'Ù…Ø§Ù„ÛŒØ§Øª',
            'Services': 'Ø®Ø¯Ù…Ø§Øª',
            'Other': 'Ø³Ø§ÛŒØ±'
        };

        const categoryColors = {
            'Rent': 'warning',
            'Equipment': 'primary',
            'Taxes': 'danger',
            'Services': 'success',
            'Other': 'gray'
        };

        async function loadExpenses(page = 1, search = '', category = '') {
            const tbody = document.getElementById('expensesTableBody');
            
            // Show loading state
            tbody.innerHTML = `
                <tr>
                    <td colspan="5">
                        <div class="text-center py-4">
                            <div class="spinner-app mx-auto mb-3"></div>
                            <div class="text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                const params = { page, per_page: 20 };
                if (search) params.q = search;
                if (category) params.category = category;
                
                const data = await APIClient.get('expenses.php', params);
                if (data.success) {
                    // Update summary
                    const summaryCard = document.getElementById('summaryCard');
                    const totalExpenses = data.data.expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                    document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
                    document.getElementById('expenseCount').textContent = data.data.pagination.total;
                    summaryCard.style.display = 'block';
                    
                    if (data.data.expenses.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5">
                                    <div class="table-empty">
                                        <div class="table-empty-icon">ğŸ’°</div>
                                        <div class="table-empty-text">Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                        summaryCard.style.display = 'none';
                    } else {
                        tbody.innerHTML = data.data.expenses.map(expense => `
                            <tr>
                                <td><strong>${expense.title}</strong></td>
                                <td>
                                    <span class="badge-app badge-app--${categoryColors[expense.category] || 'gray'}">
                                        ${categoryLabels[expense.category] || expense.category}
                                    </span>
                                </td>
                                <td><strong class="text-danger">${formatCurrency(expense.amount)}</strong></td>
                                <td>${formatJalaliDate(expense.expense_date_jalali)}</td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <button class="btn-app btn-app--primary btn-app--sm" onclick="viewExpense(${expense.id})" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn-app btn-app--secondary btn-app--sm" onclick="editExpense(${expense.id})" title="ÙˆÛŒØ±Ø§ÛŒØ´">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }

                    const paginationContainer = document.getElementById('paginationContainer');
                    if (data.data.pagination.total_pages > 1) {
                        new Pagination('paginationContainer', page, data.data.pagination.total_pages, (newPage) => {
                            currentPage = newPage;
                            loadExpenses(newPage, currentSearch, currentCategory);
                        });
                        paginationContainer.style.display = 'block';
                    } else {
                        paginationContainer.innerHTML = '';
                        paginationContainer.style.display = 'none';
                    }
                }
            } catch (error) {
                notify.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª');
            }
        }

        // Form submission
        const expenseForm = document.getElementById('expenseForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnSpinner = document.getElementById('btnSpinner');
        const btnText = document.getElementById('btnText');

        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitBtn.disabled = true;
            btnSpinner.classList.remove('d-none');
            btnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            
            let receiptPath = null;
            const receiptFile = document.getElementById('receiptUpload').files[0];
            
            if (receiptFile) {
                // Validate file size (5MB max)
                if (receiptFile.size > 5 * 1024 * 1024) {
                    notify._showSnackbar('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯', 'warning');
                    submitBtn.disabled = false;
                    btnSpinner.classList.add('d-none');
                    btnText.textContent = 'Ø°Ø®ÛŒØ±Ù‡';
                    return;
                }
                
                try {
                    btnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯...';
                    const formData = new FormData();
                    formData.append('file', receiptFile);
                    const uploadRes = await fetch(API_BASE + 'upload.php?type=receipt', {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadRes.json();
                    if (uploadData.success) {
                        receiptPath = uploadData.data.file_path;
                    } else {
                        notify._showSnackbar('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯: ' + (uploadData.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'), 'warning');
                    }
                } catch (error) {
                    console.error('Receipt upload error:', error);
                    notify._showSnackbar('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯. Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø¯ÙˆÙ† Ø±Ø³ÛŒØ¯ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.', 'warning');
                }
                btnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            }
            
            let expenseDate = document.getElementById('expenseDateAlt').value;
            const visibleDate = document.getElementById('expenseDate').value;
            
            // If altField is empty, try to parse from the visible date field
            if (!expenseDate || expenseDate.trim() === '') {
                if (visibleDate) {
                    // Convert YYYY/MM/DD to YYYY-MM-DD
                    expenseDate = visibleDate.replace(/\//g, '-');
                } else {
                    // Use current Jalali date as fallback
                    expenseDate = getCurrentJalaliDate();
                }
            }
            
            // Convert Persian/Dari numerals to ASCII
            expenseDate = convertPersianToEnglishNumbers(expenseDate);
            
            // Validate date format (YYYY-MM-DD)
            if (!expenseDate || !validateJalaliDate(expenseDate)) {
                notify.validation('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', document.getElementById('expenseDate'));
                submitBtn.disabled = false;
                btnSpinner.classList.add('d-none');
                btnText.textContent = 'Ø°Ø®ÛŒØ±Ù‡';
                return;
            }
            
            try {
                const expenseData = {
                    title: document.getElementById('expenseTitle').value.trim(),
                    category: document.getElementById('expenseCategory').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    expense_date_jalali: expenseDate,
                    details: document.getElementById('expenseDetails').value.trim()
                };
                
                // Only include receipt_path if we have one
                if (receiptPath) {
                    expenseData.receipt_path = receiptPath;
                }
                
                let result;
                if (editingExpenseId) {
                    // Update existing expense
                    result = await APIClient.put(`expenses.php?id=${editingExpenseId}`, expenseData);
                } else {
                    // Create new expense
                    result = await APIClient.post('expenses.php', expenseData);
                }
                
                if (result.success) {
                    notify.success(editingExpenseId ? 'Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
                    bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
                    expenseForm.reset();
                    editingExpenseId = null;
                    loadExpenses();
                }
            } catch (error) {
                notify.error(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡');
            } finally {
                submitBtn.disabled = false;
                btnSpinner.classList.add('d-none');
                btnText.textContent = 'Ø°Ø®ÛŒØ±Ù‡';
            }
        });
        
        document.getElementById('expenseModal').addEventListener('hidden.bs.modal', () => {
            expenseForm.reset();
            // Reset date picker
            $('#expenseDate').val('');
            $('#expenseDateAlt').val('');
            // Reset dropzone
            clearFilePreview();
            // Reset edit mode
            editingExpenseId = null;
            document.querySelector('#expenseModal .modal-title').innerHTML = '<i class="bi bi-plus-circle"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡';
            btnText.textContent = 'Ø°Ø®ÛŒØ±Ù‡';
        });

        const searchDebounced = debounce((value) => {
            currentSearch = value;
            currentPage = 1;
            loadExpenses(1, value, currentCategory);
        }, 500);

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchDebounced(e.target.value);
        });

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            currentCategory = e.target.value;
            currentPage = 1;
            loadExpenses(1, currentSearch, currentCategory);
        });

        function viewExpense(id) {
            window.location.href = `expense-detail.html?id=${id}`;
        }

        // Mobile sidebar toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
        }

        // Edit expense function
        async function editExpense(id) {
            try {
                const data = await APIClient.get(`expenses.php?id=${id}`);
                if (data.success) {
                    const e = data.data;
                    editingExpenseId = id;
                    
                    // Populate form
                    document.getElementById('expenseTitle').value = e.title;
                    document.getElementById('expenseCategory').value = e.category;
                    document.getElementById('expenseAmount').value = e.amount;
                    document.getElementById('expenseDetails').value = e.details || '';
                    
                    // Set date picker value
                    if (e.expense_date_jalali) {
                        const dateParts = e.expense_date_jalali.split('-');
                        const formattedDate = `${dateParts[0]}/${dateParts[1]}/${dateParts[2]}`;
                        $('#expenseDate').val(formattedDate);
                        $('#expenseDateAlt').val(e.expense_date_jalali);
                    }
                    
                    // Update modal title
                    document.querySelector('#expenseModal .modal-title').innerHTML = '<i class="bi bi-pencil"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø²ÛŒÙ†Ù‡';
                    
                    // Show modal
                    new bootstrap.Modal(document.getElementById('expenseModal')).show();
                }
            } catch (error) {
                notify.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø²ÛŒÙ†Ù‡');
            }
        }
        
        // Check for edit mode from URL or sessionStorage
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit') || sessionStorage.getItem('editExpenseId');
            if (editId) {
                sessionStorage.removeItem('editExpenseId');
                // Clear URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                editExpense(editId);
            }
        }

        // Initialize
        loadExpenses();
        initDarkMode();
        
        // Set current Jalali date as placeholder
        document.addEventListener('DOMContentLoaded', function() {
            const expenseDate = document.getElementById('expenseDate');
            if (expenseDate && typeof getCurrentJalaliDate === 'function') {
                const currentDate = getCurrentJalaliDate();
                expenseDate.placeholder = currentDate.replace(/-/g, '/');
            }
        });
        
        // Check edit mode after page loads
        setTimeout(checkEditMode, 500);
    </script>
</body>
</html>
