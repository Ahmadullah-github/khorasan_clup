<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/pwa-styles.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html">
            <span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>
            Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†
        </a>
        
        <ul class="navbar-nav-app">
            <li><a class="nav-link-app active" href="index.html">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
            <li><a class="nav-link-app" href="students.html">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a></li>
            <li><a class="nav-link-app" href="coaches.html">Ù…Ø±Ø¨ÛŒØ§Ù†</a></li>
            <li><a class="nav-link-app" href="expenses.html">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a></li>
            <li><a class="nav-link-app" href="rent.html">Ø§Ø¬Ø§Ø±Ù‡</a></li>
            <li><a class="nav-link-app" href="accounting.html">Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ</a></li>
            <li><a class="nav-link-app" href="reports.html">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a></li>
            <li id="adminNavItem" style="display: none;">
                <a class="nav-link-app" href="admin.html">Ù…Ø¯ÛŒØ±</a>
            </li>
        </ul>
        
        <div class="navbar-actions">
            <!-- Theme Toggle Switch -->
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons">
                    <span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span>
                    <span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span>
                </span>
                <span class="theme-switch-slider"></span>
            </button>
            
            <!-- User Info -->
            <div class="navbar-user">
                <span class="navbar-user-icon"><i class="bi bi-person"></i></span>
                <span id="userName"></span>
            </div>
            
            <!-- Logout -->
            <button class="navbar-logout" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
        
        <!-- Mobile Menu Toggle -->
        <button class="navbar-mobile-toggle" id="mobileMenuToggle">
            <i class="bi bi-list"></i>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar-app" id="sidebar">
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="index.html" class="sidebar-nav-link active">
                    <i class="bi bi-grid-1x2 sidebar-nav-icon"></i>
                    Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
            </div>
            
            <div class="sidebar-section-title">Ù…Ø¯ÛŒØ±ÛŒØª</div>
            
            <div class="sidebar-nav-item">
                <a href="students.html" class="sidebar-nav-link">
                    <i class="bi bi-people sidebar-nav-icon"></i>
                    Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="students.html?tab=new" class="sidebar-nav-link">
                    <i class="bi bi-person-plus sidebar-nav-icon"></i>
                    Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="coaches.html" class="sidebar-nav-link">
                    <i class="bi bi-person-badge sidebar-nav-icon"></i>
                    Ù…Ø±Ø¨ÛŒØ§Ù†
                </a>
            </div>
            
            <div class="sidebar-section-title">Ù…Ø§Ù„ÛŒ</div>
            
            <div class="sidebar-nav-item">
                <a href="expenses.html" class="sidebar-nav-link">
                    <i class="bi bi-cash-stack sidebar-nav-icon"></i>
                    Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="rent.html" class="sidebar-nav-link">
                    <i class="bi bi-house sidebar-nav-icon"></i>
                    Ø§Ø¬Ø§Ø±Ù‡
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="accounting.html" class="sidebar-nav-link">
                    <i class="bi bi-calculator sidebar-nav-icon"></i>
                    Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="reports.html" class="sidebar-nav-link">
                    <i class="bi bi-bar-chart sidebar-nav-icon"></i>
                    Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                </a>
            </div>
            
            <div class="sidebar-section-title">Ø³ÛŒØ³ØªÙ…</div>
            
            <div class="sidebar-nav-item" id="adminSidebarItem" style="display: none;">
                <a href="admin.html" class="sidebar-nav-link">
                    <i class="bi bi-gear sidebar-nav-icon"></i>
                    Ù…Ø¯ÛŒØ±
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link" onclick="logout()">
                    <i class="bi bi-box-arrow-right sidebar-nav-icon"></i>
                    Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container-app">
            <!-- Page Header -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="page-title mb-1">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h1>
                    <div class="text-secondary" id="currentDate"></div>
                </div>
                <div class="flex gap-2">
                    <button class="btn-app btn-app--secondary btn-app--sm" onclick="loadDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                    <button class="btn-app btn-app--primary btn-app--sm" onclick="window.pwaManager?.installApp()" id="manualInstallBtn">
                        <i class="bi bi-download"></i>
                        Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
                    </button>
                    <button class="btn-app btn-app--warning btn-app--sm" onclick="debugPWA()" id="debugBtn">
                        <i class="bi bi-bug"></i>
                        ØªØ³Øª PWA
                    </button>
                </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="row g-4 mb-6">
                <!-- Total Students -->
                <div class="col-sm-6 col-xl-3">
                    <div class="kpi-card kpi-card--primary animate-slideUp">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="kpi-card-value" id="totalStudents">
                                    <div class="skeleton skeleton-title" style="width: 60px;"></div>
                                </div>
                                <div class="kpi-card-label">Ú©Ù„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div>
                            </div>
                            <div class="kpi-card-icon mb-0">
                                <i class="bi bi-people"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="students.html" class="kpi-card-link">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„ÛŒØ³Øª</a>
                        </div>
                    </div>
                </div>
                
                <!-- Active Students -->
                <div class="col-sm-6 col-xl-3">
                    <div class="kpi-card kpi-card--success animate-slideUp" style="animation-delay: 50ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="kpi-card-value" id="activeStudents">
                                    <div class="skeleton skeleton-title" style="width: 60px;"></div>
                                </div>
                                <div class="kpi-card-label">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ÙØ¹Ø§Ù„</div>
                            </div>
                            <div class="kpi-card-icon mb-0">
                                <i class="bi bi-person-check"></i>
                            </div>
                        </div>
                        <div class="mt-3 text-secondary" style="font-size: 0.8rem;">
                            Ø¯Ø± Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Revenue -->
                <div class="col-sm-6 col-xl-3">
                    <div class="kpi-card kpi-card--info animate-slideUp" style="animation-delay: 100ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="kpi-card-value" id="monthlyRevenue">
                                    <div class="skeleton skeleton-title" style="width: 80px;"></div>
                                </div>
                                <div class="kpi-card-label">Ø¯Ø±Ø¢Ù…Ø¯ Ø§ÛŒÙ† Ù…Ø§Ù‡ (Ø§ÙØºØ§Ù†ÛŒ)</div>
                            </div>
                            <div class="kpi-card-icon mb-0">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                        </div>
                        <div class="mt-3 text-secondary" style="font-size: 0.8rem;">
                            Ø¨Ø¯ÙˆÙ† Ú©Ø³Ø± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                        </div>
                    </div>
                </div>
                
                <!-- Net Income -->
                <div class="col-sm-6 col-xl-3">
                    <div class="kpi-card kpi-card--dark animate-slideUp" style="animation-delay: 150ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="kpi-card-value" id="netIncome">
                                    <div class="skeleton skeleton-title" style="width: 80px;"></div>
                                </div>
                                <div class="kpi-card-label">Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
                            </div>
                            <div class="kpi-card-icon mb-0">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="accounting.html" class="kpi-card-link">Ø¬Ø²Ø¦ÛŒØ§Øª Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics & Actions Row -->
            <div class="row g-4 mb-6">
                <!-- Financial Trend Chart -->
                <div class="col-lg-8">
                    <div class="card-app h-100 animate-slideUp" style="animation-delay: 200ms;">
                        <div class="card-app-header">
                            <h2 class="card-app-title">
                                <i class="bi bi-bar-chart-line"></i>
                                Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø§Ù„ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
                            </h2>
                        </div>
                        <div class="card-app-body">
                            <div style="height: 300px; position: relative;">
                                <canvas id="financialChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="col-lg-4">
                    <div class="card-app h-100 animate-slideUp" style="animation-delay: 250ms;">
                        <div class="card-app-header">
                            <h2 class="card-app-title">
                                <i class="bi bi-lightning-charge"></i>
                                Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹
                            </h2>
                        </div>
                        <div class="card-app-body">
                            <div class="d-grid gap-3">
                                <a href="students.html?tab=new" class="btn-app btn-app--primary btn-app--lg justify-content-start">
                                    <i class="bi bi-person-plus ms-2"></i>
                                    Ø«Ø¨Øª Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯
                                </a>
                                <a href="expenses.html" class="btn-app btn-app--warning btn-app--lg justify-content-start">
                                    <i class="bi bi-cash-stack ms-2"></i>
                                    Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯
                                </a>
                                <a href="coaches.html" class="btn-app btn-app--success btn-app--lg justify-content-start">
                                    <i class="bi bi-person-badge ms-2"></i>
                                    Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø¨ÛŒØ§Ù†
                                </a>
                                <a href="accounting.html" class="btn-app btn-app--secondary btn-app--lg justify-content-start">
                                    <i class="bi bi-calculator ms-2"></i>
                                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø±Ø¢Ù…Ø¯
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Row -->
            <div class="row g-4">
                <!-- Recent Registrations -->
                <div class="col-lg-6">
                    <div class="card-app animate-slideUp" style="animation-delay: 300ms;">
                        <div class="card-app-header">
                            <h2 class="card-app-title">
                                <i class="bi bi-clock-history"></i>
                                Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
                            </h2>
                            <a href="reports.html" class="btn-app btn-app--ghost btn-app--sm">Ù‡Ù…Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a>
                        </div>
                        <div class="card-app-body p-0">
                            <div class="table-responsive">
                                <table class="table-app table-striped mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th>
                                            <th>Ù…Ø¨Ù„Øº (Ø§ÙØºØ§Ù†ÛŒ)</th>
                                            <th>ØªØ§Ø±ÛŒØ®</th>
                                            <th class="text-end pe-4">ÙˆØ¶Ø¹ÛŒØª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentRegistrationsTable">
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <div class="skeleton skeleton-text w-75 mx-auto"></div>
                                                <div class="skeleton skeleton-text w-50 mx-auto"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expiring Students -->
                <div class="col-lg-6">
                    <div class="card-app animate-slideUp" style="animation-delay: 350ms;">
                        <div class="card-app-header border-bottom-0 pb-0">
                            <h2 class="card-app-title text-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                                Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ØªÙ…Ø¯ÛŒØ¯ (Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡)
                            </h2>
                            <span class="badge-app badge-app--danger" id="expiringCountBadge">0</span>
                        </div>
                        <div class="card-app-body" id="expiringStudentsList">
                            <div class="skeleton skeleton-text mb-3"></div>
                            <div class="skeleton skeleton-text mb-3"></div>
                            <div class="skeleton skeleton-text"></div>
                        </div>
                        <div class="card-app-footer text-center">
                            <a href="students.html?tab=expiring" class="btn-app btn-app--ghost btn-app--sm text-danger">
                                Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/offline-manager.js"></script>
    <script src="js/pwa-manager.js"></script>
    <script src="js/jalali.js?v=2"></script>
    <script>
        // Check authentication
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.username;
            // Show Admin tab if user is admin
            if (user.role === 'admin') {
                document.getElementById('adminNavItem').style.display = 'block';
                document.getElementById('adminSidebarItem').style.display = 'block';
            }
        }

        // Display current Jalali date
        function displayCurrentDate() {
            const now = new Date();
            const jalali = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
            const monthNames = ['Ø­Ù…Ù„', 'Ø«ÙˆØ±', 'Ø¬ÙˆØ²Ø§', 'Ø³Ø±Ø·Ø§Ù†', 'Ø§Ø³Ø¯', 'Ø³Ù†Ø¨Ù„Ù‡', 'Ù…ÛŒØ²Ø§Ù†', 'Ø¹Ù‚Ø±Ø¨', 'Ù‚ÙˆØ³', 'Ø¬Ø¯ÛŒ', 'Ø¯Ù„Ùˆ', 'Ø­ÙˆØª'];
            const monthName = monthNames[jalali.month - 1];
            document.getElementById('currentDate').textContent = `${jalali.day} ${monthName} ${jalali.year}`;
            return jalali;
        }
        
        const currentJalali = displayCurrentDate();
        let financialChartInstance = null;

        // Load dashboard data
        async function loadDashboard() {
            console.log('Loading dashboard data...');
            
            // 1. Load KPI Counts
            loadKPICounts();
            
            // 2. Load Financial Data (KPIs + Chart + Recent)
            loadFinancialData();
            
            // 3. Load Expiring Students
            loadExpiringStudents();
        }

        async function loadKPICounts() {
            try {
                // Total Students
                const studentsRes = await fetch(API_BASE + 'students.php');
                const studentsData = await studentsRes.json();
                if (studentsData.success) {
                    document.getElementById('totalStudents').textContent = formatNumber(studentsData.data.pagination.total);
                }

                // Active Students
                const activeRes = await fetch(API_BASE + 'students.php?status=active');
                const activeData = await activeRes.json();
                if (activeData.success) {
                    document.getElementById('activeStudents').textContent = formatNumber(activeData.data.pagination.total);
                }
            } catch (error) {
                console.error('Error loading student counts:', error);
            }
        }

        async function loadFinancialData() {
            const month = currentJalali.month;
            const year = currentJalali.year;
            
            try {
                // Use backend API for accurate totals (avoid frontend calculation discrepancies)
                const [netIncomeRes, breakdownRes] = await Promise.all([
                    fetch(API_BASE + `accounting.php?action=net-income&month=${month}&year=${year}`),
                    fetch(API_BASE + `accounting.php?action=breakdown&month=${month}&year=${year}`)
                ]);
                
                const netIncomeData = await netIncomeRes.json();
                const breakdownData = await breakdownRes.json();
                
                // Use backend-calculated totals for KPIs (single source of truth)
                if (netIncomeData.success) {
                    document.getElementById('monthlyRevenue').textContent = formatNumber(netIncomeData.data.total_income);
                    document.getElementById('netIncome').textContent = formatNumber(netIncomeData.data.net_income);
                    
                    // Color code net income
                    const netEl = document.getElementById('netIncome');
                    if (netIncomeData.data.net_income < 0) {
                        netEl.classList.add('text-danger');
                    } else {
                        netEl.classList.remove('text-danger');
                    }
                }
                
                // Use breakdown data for chart and recent registrations
                if (breakdownData.success) {
                    const income = breakdownData.data.income || [];
                    const expenses = breakdownData.data.expenses || [];
                    
                    // Render Chart
                    renderFinancialChart(income, expenses, month, year);
                    
                    // Render Recent Registrations
                    renderRecentRegistrations(income);
                }
            } catch (error) {
                console.error('Error loading financial data:', error);
            }
        }

        /**
         * Get days in Jalali month (matches backend JalaliDate::getDaysInMonth)
         * @param {number} month Month (1-12)
         * @param {number} year Jalali year
         * @returns {number} Days in month
         */
        function getJalaliDaysInMonth(month, year) {
            if (month >= 1 && month <= 6) return 31;
            if (month >= 7 && month <= 11) return 30;
            if (month === 12) {
                // Use 33-year cycle for leap year detection
                const leapYearsInCycle = [1, 5, 9, 13, 17, 22, 26, 30];
                const yearInCycle = year % 33;
                return leapYearsInCycle.includes(yearInCycle) ? 30 : 29;
            }
            return 30;
        }

        function renderFinancialChart(incomeData, expenseData, currentMonth, currentYear) {
            const ctx = document.getElementById('financialChart').getContext('2d');
            
            // Destroy previous instance if exists
            if (financialChartInstance) {
                financialChartInstance.destroy();
            }

            // Group data by day - use proper calculation matching backend
            const daysInMonth = getJalaliDaysInMonth(currentMonth, currentYear);
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            
            const incomeByDay = new Array(daysInMonth).fill(0);
            const expenseByDay = new Array(daysInMonth).fill(0);

            incomeData.forEach(item => {
                if (item.registration_date_jalali) {
                    const day = parseInt(item.registration_date_jalali.split('-')[2]);
                    if (day >= 1 && day <= daysInMonth) {
                        incomeByDay[day - 1] += parseFloat(item.fee_amount);
                    }
                }
            });

            expenseData.forEach(item => {
                if (item.expense_date_jalali) {
                    const day = parseInt(item.expense_date_jalali.split('-')[2]);
                    if (day >= 1 && day <= daysInMonth) {
                        expenseByDay[day - 1] += parseFloat(item.amount);
                    }
                }
            });
            
            // Check for dark mode
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            const gridColor = isDarkMode ? '#334155' : '#e2e8f0';

            financialChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø¯Ø±Ø¢Ù…Ø¯',
                            data: incomeByDay,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 2
                        },
                        {
                            label: 'Ù‡Ø²ÛŒÙ†Ù‡',
                            data: expenseByDay,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { family: 'Vazirmatn' },
                                color: textColor
                            }
                        },
                        tooltip: {
                            titleFont: { family: 'Vazirmatn' },
                            bodyFont: { family: 'Vazirmatn' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false, color: gridColor },
                            ticks: { font: { family: 'Vazirmatn' }, color: textColor }
                        },
                        y: {
                            grid: { borderDash: [2, 4], color: gridColor },
                            ticks: { 
                                font: { family: 'Vazirmatn' },
                                color: textColor,
                                callback: function(value) {
                                    return new Intl.NumberFormat('fa-IR').format(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                }
            });
        }

        function renderRecentRegistrations(registrations) {
            const tbody = document.getElementById('recentRegistrationsTable');
            
            // Take top 5
            const recent = registrations.slice(0, 5);
            
            if (recent.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4 text-muted">
                            Ù‡Ù†ÙˆØ² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = recent.map(reg => `
                <tr>
                    <td class="ps-4 fw-medium text-dark">${reg.first_name} ${reg.last_name}</td>
                    <td class="text-success fw-bold">${formatNumber(reg.fee_amount)}</td>
                    <td class="text-secondary small" dir="ltr">${reg.registration_date_jalali}</td>
                    <td class="text-end pe-4">
                        <span class="badge-app badge-app--success">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>
                    </td>
                </tr>
            `).join('');
        }

        async function loadExpiringStudents() {
            try {
                const expiringRes = await fetch(API_BASE + 'students.php?action=expiring');
                const expiringData = await expiringRes.json();
                
                if (expiringData.success) {
                    const students = expiringData.data;
                    document.getElementById('expiringCountBadge').textContent = formatNumber(students.length);
                    
                    const listContainer = document.getElementById('expiringStudentsList');
                    
                    if (students.length === 0) {
                        listContainer.innerHTML = `
                            <div class="alert-app alert-app--success mb-0">
                                <i class="bi bi-check-circle alert-app-icon"></i>
                                <div class="alert-app-content">
                                    Ø¹Ø§Ù„ÛŒ! Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¯Ø± Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                                </div>
                            </div>
                        `;
                    } else {
                        // Show top 3
                        listContainer.innerHTML = students.slice(0, 3).map(s => `
                            <div class="flex items-center justify-between p-3 border rounded-3 mb-2 bg-white hover-bg-gray-50 transition-base">
                                <div class="flex items-center gap-3">
                                    <div class="width-40 height-40 rounded-circle bg-danger-50 text-danger flex items-center justify-center">
                                        <i class="bi bi-hourglass-split"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">${s.first_name} ${s.last_name}</div>
                                        <div class="text-xs text-secondary mt-1">
                                            Ù¾Ø§ÛŒØ§Ù†: <span class="fw-medium text-danger">${s.end_date_jalali}</span>
                                        </div>
                                    </div>
                                </div>
                                <a href="student-detail.html?id=${s.id}" class="btn-app btn-app--sm btn-app--secondary">
                                    ØªÙ…Ø¯ÛŒØ¯
                                </a>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading expiring students:', error);
            }
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('fa-IR').format(num);
        }

        function logout() {
            fetch(API_BASE + 'auth.php?action=logout', { method: 'POST' })
                .then(() => {
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                });
        }

        // Mobile sidebar toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
        }

        // Initialize
        loadDashboard();
        initDarkMode();
        
        // Debug function for PWA testing
        window.debugPWA = async function() {
            console.log('=== PWA Debug Information ===');
            console.log('Current URL:', window.location.href);
            console.log('Service Worker support:', 'serviceWorker' in navigator);
            
            // Check service worker registrations
            const registrations = await navigator.serviceWorker.getRegistrations();
            console.log('Service Worker registrations:', registrations);
            
            // Check manifest
            try {
                const manifestResponse = await fetch('./manifest.json');
                console.log('Manifest response status:', manifestResponse.status);
                if (manifestResponse.ok) {
                    const manifest = await manifestResponse.json();
                    console.log('Manifest content:', manifest);
                } else {
                    console.error('Manifest not accessible');
                }
            } catch (error) {
                console.error('Manifest fetch error:', error);
            }
            
            // Check service worker file
            try {
                const swResponse = await fetch('./sw.js');
                console.log('Service Worker file status:', swResponse.status);
            } catch (error) {
                console.error('Service Worker file error:', error);
            }
            
            // Check PWA manager status
            if (window.pwaManager) {
                console.log('PWA Manager status:', window.pwaManager.getInstallStatus());
            } else {
                console.error('PWA Manager not initialized');
            }
            
            // Check beforeinstallprompt support
            console.log('beforeinstallprompt fired:', !!window.pwaManager?.deferredPrompt);
            
            alert('Debug info logged to console. Press F12 to view.');
        };
        
        // Listen for theme changes to update chart
        document.getElementById('themeSwitch').addEventListener('click', () => {
            setTimeout(() => {
                loadFinancialData(); // Re-render chart with new theme colors
            }, 100);
        });
    </script>
</body>
</html>
