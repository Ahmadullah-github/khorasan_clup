<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§Ø³ - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="vendor/bootstrap/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        .time-slot-card {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            transition: all 0.2s ease;
        }
        .time-slot-card:hover {
            border-color: var(--color-primary-400);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .time-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .time-slot-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        .time-slot-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        .time-slot-actions {
            display: flex;
            gap: 0.5rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .time-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-input-wrapper input {
            width: 70px;
            text-align: center;
        }
        .time-input-wrapper .separator {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html">
            <span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>
            Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†
        </a>
        <div class="navbar-actions">
            <a href="coaches.html" class="btn-app btn-app--secondary btn-app--sm">
                <i class="bi bi-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
            </a>
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons">
                    <span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span>
                    <span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span>
                </span>
                <span class="theme-switch-slider"></span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="app-main" style="margin-right: 0;">
        <div class="container-app" style="max-width: 800px;">
            <div class="page-header">
                <h1 class="page-title mb-0">
                    <i class="bi bi-clock me-2"></i>
                    Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§Ø³
                </h1>
                <button class="btn-app btn-app--primary" id="addTimeSlotBtn">
                    <i class="bi bi-plus-lg"></i>
                    Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯
                </button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5">
                <div class="spinner-app mx-auto mb-3"></div>
                <div class="text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>

            <!-- Time Slots List -->
            <div id="timeSlotsContainer" style="display: none;"></div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ğŸ•</div>
                <h3>Ù‡ÛŒÚ† Ø²Ù…Ø§Ù† Ú©Ù„Ø§Ø³ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡</h3>
                <p class="text-muted mb-4">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§ÙˆÙ„ÛŒÙ† Ø²Ù…Ø§Ù† Ú©Ù„Ø§Ø³ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</p>
                <button class="btn-app btn-app--primary" id="addFirstSlotBtn">
                    <i class="bi bi-plus-lg"></i>
                    Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù† Ø§ÙˆÙ„
                </button>
            </div>
        </div>
    </main>

    <!-- Time Slot Modal -->
    <div class="modal fade" id="timeSlotModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
                </div>
                <div class="modal-body">
                    <form id="timeSlotForm" novalidate>
                        <div class="mb-3">
                            <label class="form-label-app required">
                                <i class="bi bi-tag"></i> Ù†Ø§Ù… Ø²Ù…Ø§Ù†
                            </label>
                            <input type="text" class="form-control-app" id="slotName" 
                                   placeholder="Ù…Ø«Ø§Ù„: ØµØ¨Ø­ØŒ Ø¸Ù‡Ø±ØŒ Ø´Ø§Ù…" required>
                            <div class="invalid-feedback">Ù†Ø§Ù… Ø²Ù…Ø§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label class="form-label-app required">
                                    <i class="bi bi-clock"></i> Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
                                </label>
                                <div class="time-input-wrapper">
                                    <input type="number" class="form-control-app" id="startHour" 
                                           placeholder="Ø³Ø§Ø¹Øª" min="0" max="23" required>
                                    <span class="separator">:</span>
                                    <input type="number" class="form-control-app" id="startMinute" 
                                           placeholder="Ø¯Ù‚ÛŒÙ‚Ù‡" min="0" max="59" value="0">
                                </div>
                                <div class="invalid-feedback" id="startTimeError">Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label-app required">
                                    <i class="bi bi-clock-fill"></i> Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†
                                </label>
                                <div class="time-input-wrapper">
                                    <input type="number" class="form-control-app" id="endHour" 
                                           placeholder="Ø³Ø§Ø¹Øª" min="0" max="23" required>
                                    <span class="separator">:</span>
                                    <input type="number" class="form-control-app" id="endMinute" 
                                           placeholder="Ø¯Ù‚ÛŒÙ‚Ù‡" min="0" max="59" value="0">
                                </div>
                                <div class="invalid-feedback" id="endTimeError">Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-app">
                                <i class="bi bi-info-circle"></i> ØªÙˆØ¶ÛŒØ­Ø§Øª
                            </label>
                            <textarea class="form-control-app" id="slotDescription" rows="2" 
                                      placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app--secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="button" class="btn-app btn-app--primary" id="submitBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="btnSpinner"></span>
                        <i class="bi bi-check-lg" id="btnIcon"></i>
                        <span id="btnText">Ø°Ø®ÛŒØ±Ù‡</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
                </div>
                <div class="modal-body">
                    <p>Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø²Ù…Ø§Ù† <strong id="deleteSlotName"></strong> Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app--secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="button" class="btn-app btn-app--danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash"></i> Ø­Ø°Ù
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/app-settings.js"></script>
    <script>
        // Auth check
        const user = checkAuth();
        if (!user) window.location.href = 'login.html';

        // State
        let timeSlots = [];
        let editingSlotId = null;
        let deletingSlotId = null;

        // DOM Elements
        const loadingState = document.getElementById('loadingState');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const emptyState = document.getElementById('emptyState');
        const timeSlotForm = document.getElementById('timeSlotForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnSpinner = document.getElementById('btnSpinner');
        const btnIcon = document.getElementById('btnIcon');
        const btnText = document.getElementById('btnText');

        // Bootstrap Modals
        let timeSlotModal, deleteModal;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDarkMode();
            
            // Initialize Bootstrap modals
            timeSlotModal = new bootstrap.Modal(document.getElementById('timeSlotModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            
            // Event listeners
            document.getElementById('addTimeSlotBtn').addEventListener('click', () => openModal());
            document.getElementById('addFirstSlotBtn').addEventListener('click', () => openModal());
            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
            
            // Reset form when modal closes
            document.getElementById('timeSlotModal').addEventListener('hidden.bs.modal', resetForm);
            
            // Load data
            loadTimeSlots();
        });

        // Load time slots from API
        async function loadTimeSlots() {
            showLoading();
            
            try {
                const response = await APIClient.get('coaches.php', { action: 'time-slots' });
                
                if (response.success && Array.isArray(response.data)) {
                    timeSlots = response.data;
                    renderTimeSlots();
                } else {
                    throw new Error(response.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§');
                }
            } catch (error) {
                console.error('Error loading time slots:', error);
                notify.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§: ' + error.message);
                loadingState.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ. <a href="#" onclick="loadTimeSlots(); return false;">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</a>
                    </div>
                `;
            }
        }

        // Show loading state
        function showLoading() {
            loadingState.style.display = 'block';
            timeSlotsContainer.style.display = 'none';
            emptyState.style.display = 'none';
        }

        // Render time slots
        function renderTimeSlots() {
            loadingState.style.display = 'none';
            
            if (timeSlots.length === 0) {
                timeSlotsContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            timeSlotsContainer.style.display = 'block';
            
            timeSlotsContainer.innerHTML = timeSlots.map(slot => `
                <div class="time-slot-card" data-id="${slot.id}">
                    <div class="time-slot-header">
                        <div>
                            <div class="time-slot-name">${escapeHtml(slot.name)}</div>
                            <div class="time-slot-time">
                                <i class="bi bi-clock"></i>
                                ${slot.start_time} - ${slot.end_time}
                            </div>
                            ${slot.description ? `<div class="text-muted small mt-1">${escapeHtml(slot.description)}</div>` : ''}
                        </div>
                        <div class="time-slot-actions">
                            <button class="btn-app btn-app--secondary btn-app--sm" 
                                    onclick="editTimeSlot(${slot.id})" title="ÙˆÛŒØ±Ø§ÛŒØ´">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn-app btn-app--danger btn-app--sm" 
                                    onclick="deleteTimeSlot(${slot.id})" title="Ø­Ø°Ù">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Open modal for add/edit
        function openModal(slotId = null) {
            // Reset form first (but don't clear editingSlotId yet)
            timeSlotForm.reset();
            clearValidation();
            setSubmitLoading(false);
            
            // Now set the editing ID
            editingSlotId = slotId;
            
            const modalTitle = document.getElementById('modalTitle');
            
            if (slotId) {
                const slot = timeSlots.find(s => s.id === slotId);
                if (!slot) return;
                
                modalTitle.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø²Ù…Ø§Ù†';
                btnText.textContent = 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ';
                
                document.getElementById('slotName').value = slot.name;
                document.getElementById('slotDescription').value = slot.description || '';
                
                // Parse times (format: HH:MM or HH:MM:SS)
                const [startH, startM] = slot.start_time.split(':');
                const [endH, endM] = slot.end_time.split(':');
                
                document.getElementById('startHour').value = parseInt(startH, 10);
                document.getElementById('startMinute').value = parseInt(startM, 10);
                document.getElementById('endHour').value = parseInt(endH, 10);
                document.getElementById('endMinute').value = parseInt(endM, 10);
            } else {
                modalTitle.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯';
                btnText.textContent = 'Ø°Ø®ÛŒØ±Ù‡';
            }
            
            timeSlotModal.show();
        }

        // Edit time slot
        function editTimeSlot(slotId) {
            openModal(slotId);
        }

        // Delete time slot - show confirmation
        function deleteTimeSlot(slotId) {
            const slot = timeSlots.find(s => s.id === slotId);
            if (!slot) return;
            
            deletingSlotId = slotId;
            document.getElementById('deleteSlotName').textContent = slot.name;
            deleteModal.show();
        }

        // Confirm delete
        async function confirmDelete() {
            if (!deletingSlotId) return;
            
            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù...';
            
            try {
                const result = await APIClient.delete(`coaches.php?action=time-slots&id=${deletingSlotId}`);
                
                if (result.success) {
                    notify.success('Ø²Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    deleteModal.hide();
                    await loadTimeSlots();
                } else {
                    throw new Error(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete error:', error);
                notify.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-trash"></i> Ø­Ø°Ù';
                deletingSlotId = null;
            }
        }

        // Handle form submit
        async function handleSubmit() {
            // Clear previous errors
            clearValidation();
            
            // Get values
            const name = document.getElementById('slotName').value.trim();
            const startHour = parseInt(document.getElementById('startHour').value);
            const startMinute = parseInt(document.getElementById('startMinute').value) || 0;
            const endHour = parseInt(document.getElementById('endHour').value);
            const endMinute = parseInt(document.getElementById('endMinute').value) || 0;
            const description = document.getElementById('slotDescription').value.trim();
            
            // Validation
            let isValid = true;
            
            if (!name) {
                document.getElementById('slotName').classList.add('is-invalid');
                isValid = false;
            }
            
            if (isNaN(startHour) || startHour < 0 || startHour > 23) {
                document.getElementById('startHour').classList.add('is-invalid');
                document.getElementById('startTimeError').textContent = 'Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                isValid = false;
            }
            
            if (isNaN(endHour) || endHour < 0 || endHour > 23) {
                document.getElementById('endHour').classList.add('is-invalid');
                document.getElementById('endTimeError').textContent = 'Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                isValid = false;
            }
            
            // Check time logic
            if (isValid) {
                const startTotal = startHour * 60 + startMinute;
                const endTotal = endHour * 60 + endMinute;
                
                if (endTotal <= startTotal) {
                    document.getElementById('endHour').classList.add('is-invalid');
                    document.getElementById('endTimeError').textContent = 'Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯';
                    isValid = false;
                }
            }
            
            if (!isValid) {
                notify._showSnackbar('Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'warning');
                return;
            }
            
            // Format times
            const startTime = `${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`;
            const endTime = `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
            
            const formData = {
                name,
                start_time: startTime,
                end_time: endTime,
                description: description || null
            };
            
            // Show loading
            setSubmitLoading(true);
            
            try {
                let result;
                if (editingSlotId) {
                    result = await APIClient.put(`coaches.php?action=time-slots&id=${editingSlotId}`, formData);
                } else {
                    result = await APIClient.post('coaches.php?action=time-slots', formData);
                }
                
                if (result.success) {
                    notify.success(editingSlotId ? 'Ø²Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯' : 'Ø²Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
                    timeSlotModal.hide();
                    await loadTimeSlots();
                } else {
                    throw new Error(result.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
                }
            } catch (error) {
                console.error('Submit error:', error);
                notify.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + error.message);
            } finally {
                setSubmitLoading(false);
            }
        }

        // Set submit button loading state
        function setSubmitLoading(loading) {
            submitBtn.disabled = loading;
            btnSpinner.classList.toggle('d-none', !loading);
            btnIcon.classList.toggle('d-none', loading);
            btnText.textContent = loading ? 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...' : (editingSlotId ? 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ' : 'Ø°Ø®ÛŒØ±Ù‡');
        }

        // Reset form (only used when modal closes)
        function resetForm() {
            timeSlotForm.reset();
            clearValidation();
            editingSlotId = null;
            setSubmitLoading(false);
        }

        // Clear validation errors
        function clearValidation() {
            timeSlotForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>