<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        .breakdown-header {
            background: linear-gradient(135deg, var(--color-gray-700) 0%, var(--color-gray-900) 100%);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            color: white;
            margin-bottom: var(--space-6);
        }
        .breakdown-title { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); }
        .breakdown-subtitle { opacity: 0.7; margin-top: var(--space-2); }
        .section-card { margin-bottom: var(--space-5); }
        .section-header {
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            color: white;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .section-header--income { background: linear-gradient(135deg, var(--color-success-500) 0%, var(--color-success-600) 100%); }
        .section-header--expense { background: linear-gradient(135deg, var(--color-danger-500) 0%, var(--color-danger-600) 100%); }
        .section-header--coach { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .section-body {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }
    </style>
</head>
<body>
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html"><span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</a>
        <div class="navbar-actions">
            <a href="accounting.html" class="btn-app btn-app--secondary btn-app--sm"><i class="bi bi-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons"><span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span><span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span></span>
                <span class="theme-switch-slider"></span>
            </button>
        </div>
    </nav>
    <main class="app-main" style="margin-right: 0;">
        <div class="container-app">
            <div class="breakdown-header animate-slideUp">
                <div class="breakdown-title"><i class="bi bi-list-columns-reverse me-2"></i>Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
                <div class="breakdown-subtitle" id="breakdownMeta"></div>
            </div>
            <div id="breakdownContent">
                <div class="text-center py-5"><div class="spinner-app mx-auto"></div></div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/jalali.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        const month = urlParams.get('month');
        const year = urlParams.get('year');
        const id = urlParams.get('id');
        const monthNames = ['Ø­Ù…Ù„', 'Ø«ÙˆØ±', 'Ø¬ÙˆØ²Ø§', 'Ø³Ø±Ø·Ø§Ù†', 'Ø§Ø³Ø¯', 'Ø³Ù†Ø¨Ù„Ù‡', 'Ù…ÛŒØ²Ø§Ù†', 'Ø¹Ù‚Ø±Ø¨', 'Ù‚ÙˆØ³', 'Ø¬Ø¯ÛŒ', 'Ø¯Ù„Ùˆ', 'Ø­ÙˆØª'];
        document.getElementById('breakdownMeta').textContent = `${monthNames[month-1]} ${year}`;

        async function loadBreakdown() {
            try {
                // Validate parameters
                if (!month || !year || !type) {
                    console.error('Missing params:', { month, year, type, id });
                    showAlert('Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù†Ø§Ù‚Øµ', 'danger');
                    return;
                }
                
                const url = `accounting.php?action=breakdown&month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}&type=${encodeURIComponent(type)}${id ? '&id=' + encodeURIComponent(id) : ''}`;
                console.log('Breakdown API URL:', url);
                console.log('Full URL will be:', API_BASE + url);
                console.log('Params:', { month, year, type, id });
                const data = await APIClient.request(url, { method: 'GET' });
                if (data.success) {
                    let html = '';
                    if (data.data.income) {
                        html += `
                            <div class="section-card animate-slideUp">
                                <div class="section-header section-header--income"><i class="bi bi-arrow-down-circle"></i> Ø¯Ø±Ø¢Ù…Ø¯ (${data.data.income.length} Ù…ÙˆØ±Ø¯)</div>
                                <div class="section-body">
                                    <div class="table-responsive">
                                        <table class="table-app">
                                            <thead><tr><th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th><th>Ù…Ø±Ø¨ÛŒ</th><th>Ø²Ù…Ø§Ù† Ú©Ù„Ø§Ø³</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
                                            <tbody>
                                                ${data.data.income.map(i => `
                                                    <tr>
                                                        <td><strong>${i.first_name} ${i.last_name}</strong></td>
                                                        <td>${i.coach_first_name} ${i.coach_last_name}</td>
                                                        <td><span class="badge-app badge-app--primary">${i.time_slot_name}</span></td>
                                                        <td class="text-success">${formatCurrency(i.fee_amount)}</td>
                                                        <td>${formatJalaliDate(i.registration_date_jalali)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    if (data.data.expenses) {
                        html += `
                            <div class="section-card animate-slideUp" style="animation-delay: 100ms;">
                                <div class="section-header section-header--expense"><i class="bi bi-arrow-up-circle"></i> Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ (${data.data.expenses.length} Ù…ÙˆØ±Ø¯)</div>
                                <div class="section-body">
                                    <div class="table-responsive">
                                        <table class="table-app">
                                            <thead><tr><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø¯Ø³ØªÙ‡</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                                            <tbody>
                                                ${data.data.expenses.map(e => `
                                                    <tr>
                                                        <td><strong>${e.title}</strong></td>
                                                        <td><span class="badge-app badge-app--warning">${e.category}</span></td>
                                                        <td class="text-danger">${formatCurrency(e.amount)}</td>
                                                        <td>${formatJalaliDate(e.expense_date_jalali)}</td>
                                                        <td><a href="expense-detail.html?id=${e.id}" class="btn-app btn-app--primary btn-app--sm"><i class="bi bi-eye"></i></a></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    if (data.data.coach_transactions) {
                        html += `
                            <div class="section-card animate-slideUp" style="animation-delay: 200ms;">
                                <div class="section-header section-header--coach"><i class="bi bi-person-badge"></i> ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÛŒ (${data.data.coach_transactions.length} Ù…ÙˆØ±Ø¯)</div>
                                <div class="section-body">
                                    <div class="table-responsive">
                                        <table class="table-app">
                                            <thead><tr><th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th><th>Ø²Ù…Ø§Ù† Ú©Ù„Ø§Ø³</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
                                            <tbody>
                                                ${data.data.coach_transactions.map(t => `
                                                    <tr>
                                                        <td><strong>${t.first_name} ${t.last_name}</strong></td>
                                                        <td><span class="badge-app badge-app--primary">${t.time_slot_name}</span></td>
                                                        <td class="text-success">${formatCurrency(t.fee_amount)}</td>
                                                        <td>${formatJalaliDate(t.registration_date_jalali)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    document.getElementById('breakdownContent').innerHTML = html || '<div class="alert-app alert-app--warning"><i class="bi bi-info-circle"></i> Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                }
            } catch (error) { showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'danger'); }
        }
        loadBreakdown();
        initDarkMode();
    </script>
</body>
</html>
