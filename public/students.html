<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html">
            <span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>
            Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†
        </a>
        
        <ul class="navbar-nav-app">
            <li><a class="nav-link-app" href="index.html">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
            <li><a class="nav-link-app active" href="students.html">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a></li>
            <li><a class="nav-link-app" href="coaches.html">Ù…Ø±Ø¨ÛŒØ§Ù†</a></li>
            <li><a class="nav-link-app" href="expenses.html">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a></li>
            <li><a class="nav-link-app" href="rent.html">Ø§Ø¬Ø§Ø±Ù‡</a></li>
            <li><a class="nav-link-app" href="accounting.html">Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ</a></li>
            <li><a class="nav-link-app" href="reports.html">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a></li>
            <li id="adminNavItem" style="display: none;">
                <a class="nav-link-app" href="admin.html">Ù…Ø¯ÛŒØ±</a>
            </li>
        </ul>
        
        <div class="navbar-actions">
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons">
                    <span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span>
                    <span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span>
                </span>
                <span class="theme-switch-slider"></span>
            </button>
            <div class="navbar-user">
                <span class="navbar-user-icon"><i class="bi bi-person"></i></span>
                <span id="userName"></span>
            </div>
            <button class="navbar-logout" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
        
        <button class="navbar-mobile-toggle" id="mobileMenuToggle">
            <i class="bi bi-list"></i>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar-app" id="sidebar">
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="index.html" class="sidebar-nav-link">
                    <i class="bi bi-grid-1x2 sidebar-nav-icon"></i>
                    Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
            </div>
            
            <div class="sidebar-section-title">Ù…Ø¯ÛŒØ±ÛŒØª</div>
            
            <div class="sidebar-nav-item">
                <a href="students.html" class="sidebar-nav-link active">
                    <i class="bi bi-people sidebar-nav-icon"></i>
                    Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="students.html?tab=new" class="sidebar-nav-link">
                    <i class="bi bi-person-plus sidebar-nav-icon"></i>
                    Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="coaches.html" class="sidebar-nav-link">
                    <i class="bi bi-person-badge sidebar-nav-icon"></i>
                    Ù…Ø±Ø¨ÛŒØ§Ù†
                </a>
            </div>
            
            <div class="sidebar-section-title">Ù…Ø§Ù„ÛŒ</div>
            
            <div class="sidebar-nav-item">
                <a href="expenses.html" class="sidebar-nav-link">
                    <i class="bi bi-cash-stack sidebar-nav-icon"></i>
                    Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="rent.html" class="sidebar-nav-link">
                    <i class="bi bi-house sidebar-nav-icon"></i>
                    Ø§Ø¬Ø§Ø±Ù‡
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="accounting.html" class="sidebar-nav-link">
                    <i class="bi bi-calculator sidebar-nav-icon"></i>
                    Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="reports.html" class="sidebar-nav-link">
                    <i class="bi bi-bar-chart sidebar-nav-icon"></i>
                    Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                </a>
            </div>
            
            <div class="sidebar-section-title">Ø³ÛŒØ³ØªÙ…</div>
            
            <div class="sidebar-nav-item" id="adminSidebarItem" style="display: none;">
                <a href="admin.html" class="sidebar-nav-link">
                    <i class="bi bi-gear sidebar-nav-icon"></i>
                    Ù…Ø¯ÛŒØ±
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link" onclick="logout()">
                    <i class="bi bi-box-arrow-right sidebar-nav-icon"></i>
                    Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container-app">
            <!-- Page Header -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="page-title mb-0">
                    <i class="bi bi-people me-2"></i>
                    Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
                </h1>
            </div>

            <!-- Tabs -->
            <div class="tabs-app" id="studentTabs">
                <button class="tab-app" data-tab="newStudent">
                    <i class="bi bi-person-plus me-2"></i>
                    Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯
                </button>
                <button class="tab-app active" data-tab="existingStudents">
                    <i class="bi bi-list-ul me-2"></i>
                    Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- New Student Form -->
                <div class="tab-pane" id="newStudent" style="display: none;">
                    <div class="card-app animate-slideUp">
                        <div class="card-app-header">
                            <h2 class="card-app-title">
                                <i class="bi bi-person-plus"></i>
                                Ø«Ø¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯
                            </h2>
                        </div>
                        <div class="card-app-body">
                            <form id="newStudentForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app required">
                                                <i class="bi bi-person"></i>
                                                Ù†Ø§Ù…
                                            </label>
                                            <input type="text" class="form-control-app" id="firstName" required placeholder="Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app required">
                                                <i class="bi bi-person"></i>
                                                Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ
                                            </label>
                                            <input type="text" class="form-control-app" id="lastName" required placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app">
                                                <i class="bi bi-person-badge"></i>
                                                Ù†Ø§Ù… Ù¾Ø¯Ø±
                                            </label>
                                            <input type="text" class="form-control-app" id="fatherName" placeholder="Ù†Ø§Ù… Ù¾Ø¯Ø±">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app">
                                                <i class="bi bi-telephone"></i>
                                                Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³
                                            </label>
                                            <input type="text" class="form-control-app" id="contactNumber" placeholder="07XXXXXXXX">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app required">
                                                <i class="bi bi-cash"></i>
                                                Ù…Ø¨Ù„Øº Ø­Ù‚â€ŒØ§Ù„Ø§Ø´ØªØ±Ø§Ú©
                                            </label>
                                            <div class="input-group-app">
                                                <input type="number" class="form-control-app" id="feeAmount" min="0" required placeholder="0">
                                                <span class="input-group-prepend">Ø§ÙØºØ§Ù†ÛŒ</span>
                                           
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app required">
                                                <i class="bi bi-calendar3"></i>
                                                ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª (Ø¬Ù„Ø§Ù„ÛŒ)
                                            </label>
                                            <input type="text" class="form-control-app" id="registrationDate" required placeholder="1404/01/01">
                                            <input type="hidden" id="registrationDateAlt">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app required">
                                                <i class="bi bi-person-badge"></i>
                                                Ù…Ø±Ø¨ÛŒ
                                            </label>
                                            <select class="form-control-app form-select-app" id="coachId" required>
                                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label-app required">
                                                <i class="bi bi-clock"></i>
                                                Ø²Ù…Ø§Ù† Ú©Ù„Ø§Ø³
                                            </label>
                                            <select class="form-control-app form-select-app" id="timeSlotId" required>
                                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label-app">
                                        <i class="bi bi-image"></i>
                                        Ø¹Ú©Ø³
                                    </label>
                                    <div class="photo-upload-container" id="photoUploadContainer">
                                        <div class="photo-preview" id="photoPreview" style="display: none;">
                                            <img id="photoPreviewImg" src="" alt="Preview">
                                            <button type="button" class="photo-preview-remove" id="removePhoto" title="Ø­Ø°Ù Ø¹Ú©Ø³">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <div class="photo-dropzone" id="photoDropzone">
                                            <i class="bi bi-cloud-upload photo-dropzone-icon"></i>
                                            <p class="photo-dropzone-text">Ø¹Ú©Ø³ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                                            <p class="photo-dropzone-hint">Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª (JPEG, PNG, GIF)</p>
                                            <input type="file" class="photo-input-hidden" id="photoUpload" accept="image/*">
                                        </div>
                                        <div class="photo-upload-progress" id="photoProgress" style="display: none;">
                                            <div class="progress-bar-app">
                                                <div class="progress-bar-fill" id="photoProgressBar" style="width: 0%"></div>
                                            </div>
                                            <span class="progress-text" id="photoProgressText">0%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label-app">
                                        <i class="bi bi-sticky"></i>
                                        ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
                                    </label>
                                    <textarea class="form-control-app" id="notes" rows="3" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ..."></textarea>
                                </div>
                                <button type="submit" class="btn-app btn-app--primary btn-app--lg">
                                    <i class="bi bi-check-lg"></i>
                                    Ø«Ø¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Existing Students List -->
                <div class="tab-pane" id="existingStudents">
                    <div class="card-app animate-slideUp">
                        <div class="card-app-header">
                            <h2 class="card-app-title">
                                <i class="bi bi-list-ul"></i>
                                Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
                            </h2>
                            <div class="header-actions">
                                <div class="search-box-app">
                                    <i class="bi bi-search search-icon"></i>
                                    <input type="text" class="search-input" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
                                    <button type="button" class="search-clear" id="searchClear" style="display: none;" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <div class="bulk-actions" id="bulkActions" style="display: none;">
                                    <button class="btn-app btn-app--danger btn-app--sm" id="bulkDeleteBtn">
                                        <i class="bi bi-trash"></i>
                                        Ø­Ø°Ù Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-app-body p-0">
                            <div class="table-responsive">
                                <table class="table-app">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" class="form-check-input" id="selectAll" title="Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡">
                                            </th>
                                            <th>Ù†Ø§Ù…</th>
                                            <th>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th>
                                            <th>Ù†Ø§Ù… Ù¾Ø¯Ø±</th>
                                            <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th>
                                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <tr>
                                            <td colspan="6">
                                                <div class="text-center py-4">
                                                    <div class="spinner-app mx-auto mb-3"></div>
                                                    <div class="text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-app-footer" id="paginationContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Confirmation Modal -->
    <div class="modal fade modal-app" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        ØªØ£ÛŒÛŒØ¯ Ø¹Ù…Ù„ÛŒØ§Øª
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app--secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="button" class="btn-app btn-app--danger" id="confirmModalBtn">ØªØ£ÛŒÛŒØ¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade modal-app" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil"></i>
                        ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label-app required">Ù†Ø§Ù…</label>
                                    <input type="text" class="form-control-app" id="editFirstName" required>
                                    <div class="invalid-feedback">Ù†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label-app required">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                                    <input type="text" class="form-control-app" id="editLastName" required>
                                    <div class="invalid-feedback">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label-app">Ù†Ø§Ù… Ù¾Ø¯Ø±</label>
                                    <input type="text" class="form-control-app" id="editFatherName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label-app">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
                                    <input type="text" class="form-control-app" id="editContactNumber" placeholder="07XXXXXXXX">
                                    <div class="invalid-feedback">ÙØ±Ù…Øª Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label-app">ÙˆØ¶Ø¹ÛŒØª</label>
                                    <select class="form-control-app form-select-app" id="editStatus">
                                        <option value="active">ÙØ¹Ø§Ù„</option>
                                        <option value="inactive">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label-app">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
                            <textarea class="form-control-app" id="editNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app--secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="button" class="btn-app btn-app--primary" id="saveEditBtn">
                        <i class="bi bi-check-lg"></i>
                        Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade modal-app" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt"></i>
                        ÙØ§Ú©ØªÙˆØ± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-4">Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: <strong id="invoiceNumber"></strong></p>
                    <div class="d-grid gap-3">
                        <button class="btn-app btn-app--primary w-100" id="viewInvoiceBtn">
                            <i class="bi bi-eye"></i>
                            Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±
                        </button>
                        <button class="btn-app btn-app--success w-100" id="shareWhatsAppBtn">
                            <i class="bi bi-whatsapp"></i>
                            Ø§Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ù¾
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.0.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/jalali.js"></script>
    <script>
        let currentPage = 1;
        let currentSearch = '';
        let currentInvoiceId = null;

        // Check auth
        const user = checkAuth();
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.username;
            if (user.role === 'admin') {
                document.getElementById('adminNavItem').style.display = 'block';
                document.getElementById('adminSidebarItem').style.display = 'block';
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-app').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update tab buttons
                document.querySelectorAll('.tab-app').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update tab content
                const tabId = tab.getAttribute('data-tab');
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.style.display = pane.id === tabId ? 'block' : 'none';
                });
            });
        });

        // Check URL for tab parameter
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        if (tabParam === 'new') {
            document.querySelector('[data-tab="newStudent"]').click();
        }

        // Load form data
        async function loadFormData() {
            try {
                const data = await APIClient.get('students.php?action=new');
                if (data.success) {
                    const coachSelect = document.getElementById('coachId');
                    const timeSlotSelect = document.getElementById('timeSlotId');
                    
                    coachSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
                    data.data.coaches.forEach(coach => {
                        const option = document.createElement('option');
                        option.value = coach.id;
                        option.textContent = `${coach.first_name} ${coach.last_name}`;
                        coachSelect.appendChild(option);
                    });

                    timeSlotSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
                    data.data.time_slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.id;
                        option.textContent = slot.name;
                        timeSlotSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'danger');
            }
        }

        // Initialize date picker
        $(document).ready(function() {
            // Set default to today's Jalali date
            const now = new Date();
            const jalali = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
            const todayJalali = `${jalali.year}/${String(jalali.month).padStart(2, '0')}/${String(jalali.day).padStart(2, '0')}`;
            
            $('#registrationDate').val(todayJalali);
            
            $('#registrationDate').persianDatepicker({
                observer: true,
                format: 'YYYY/MM/DD',
                altField: '#registrationDateAlt',
                altFormat: 'YYYY-MM-DD',
                initialValue: true
            });
        });

        // Handle form submission
        document.getElementById('newStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-app spinner-app--sm"></span> Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
            
            let photoPath = null;
            const photoFile = document.getElementById('photoUpload').files[0];
            
            if (photoFile) {
                try {
                    photoPath = await uploadPhotoWithProgress(photoFile);
                    if (!photoPath) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalHTML;
                        return;
                    }
                } catch (error) {
                    console.error('Photo upload error:', error);
                    showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³: ' + (error.message || 'Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'), 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    return;
                }
            }
            
            // Get Jalali date from the date picker
            let registrationDate = null;
            const dateInput = document.getElementById('registrationDate');
            let dateValue = dateInput.value.trim();
            
            console.log('Date input value (raw):', dateValue); // Debug
            
            // Convert Persian digits to English digits if present
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            persianDigits.forEach((persian, index) => {
                dateValue = dateValue.replace(new RegExp(persian, 'g'), englishDigits[index]);
            });
            
            console.log('Date input value (converted):', dateValue); // Debug
            
            if (dateValue) {
                // The date picker stores date in YYYY/MM/DD format
                // Convert to YYYY-MM-DD format
                registrationDate = dateValue.replace(/\//g, '-');
                
                // Ensure proper format (handle cases where date might have spaces or other characters)
                registrationDate = registrationDate.replace(/\s+/g, ''); // Remove spaces
                
                // Validate the format (should be YYYY-MM-DD)
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (!datePattern.test(registrationDate)) {
                    console.error('Invalid date format after conversion:', registrationDate, 'Original:', dateInput.value);
                    showAlert('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ø² ØªÙ‚ÙˆÛŒÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    return;
                }
                
                // Validate actual date validity using jalali validation function
                if (!validateJalaliDate(registrationDate)) {
                    console.error('Invalid Jalali date:', registrationDate);
                    showAlert('ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± Ø¬Ù„Ø§Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    return;
                }
            } else {
                // If no date selected, use current Jalali date
                const now = new Date();
                const jalali = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
                registrationDate = `${jalali.year}-${String(jalali.month).padStart(2, '0')}-${String(jalali.day).padStart(2, '0')}`;
                console.log('Using current date:', registrationDate);
            }
            
            console.log('Final registration date:', registrationDate); // Debug
            
            // Client-side validation
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const feeAmount = parseFloat(document.getElementById('feeAmount').value);
            const coachId = parseInt(document.getElementById('coachId').value);
            const timeSlotId = parseInt(document.getElementById('timeSlotId').value);
            
            // Validate required fields
            if (!firstName || !lastName) {
                showAlert('Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
                return;
            }
            
            // Validate contact number format if provided
            if (contactNumber && !/^0[0-9]{9}$/.test(contactNumber)) {
                showAlert('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ 0 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ Ùˆ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
                return;
            }
            
            // Validate fee amount
            if (isNaN(feeAmount) || feeAmount < 0) {
                showAlert('Ù…Ø¨Ù„Øº Ø­Ù‚â€ŒØ§Ù„Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± Ùˆ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
                return;
            }
            
            // Validate coach and time slot
            if (!coachId || isNaN(coachId)) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ù…Ø±Ø¨ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
                return;
            }
            
            if (!timeSlotId || isNaN(timeSlotId)) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ø²Ù…Ø§Ù† Ú©Ù„Ø§Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
                return;
            }
            
            const formData = {
                first_name: firstName,
                last_name: lastName,
                father_name: document.getElementById('fatherName').value.trim(),
                contact_number: contactNumber,
                fee_amount: feeAmount,
                registration_date_jalali: registrationDate,
                coach_id: coachId,
                time_slot_id: timeSlotId,
                photo_path: photoPath,
                notes: document.getElementById('notes').value.trim()
            };

            try {
                const result = await APIClient.post('students.php', formData);
                if (result.success) {
                    showAlert('Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'success');
                    document.getElementById('newStudentForm').reset();
                    showInvoiceModal(result.data.invoice_id, result.data.invoice_number);
                    loadStudents();
                }
            } catch (error) {
                // Show detailed error message from server
                const errorMsg = error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²';
                showAlert(errorMsg, 'danger');
                console.error('Student creation error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        });

        // Load students list
        async function loadStudents(page = 1, search = '') {
            try {
                const params = { page, per_page: 20 };
                if (search) params.q = search;
                
                const data = await APIClient.get('students.php', params);
                if (data.success) {
                    const tbody = document.getElementById('studentsTableBody');
                    if (data.data.students.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6">
                                    <div class="table-empty">
                                        <div class="table-empty-icon">ğŸ“‹</div>
                                        <div class="table-empty-text">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = data.data.students.map(student => `
                            <tr data-student-id="${student.id}">
                                <td>
                                    <input type="checkbox" class="form-check-input student-checkbox" data-id="${student.id}">
                                </td>
                                <td>
                                    <div class="student-name-cell">
                                        ${student.photo_path ? `<img src="${student.photo_path}" class="student-avatar" alt="">` : `<div class="student-avatar-placeholder"><i class="bi bi-person"></i></div>`}
                                        <span>${student.first_name}</span>
                                    </div>
                                </td>
                                <td>${student.last_name}</td>
                                <td>${student.father_name || '-'}</td>
                                <td>${student.contact_number || '-'}</td>
                                <td>
                                    <button class="badge-app badge-app--clickable ${student.status === 'active' ? 'badge-app--success' : 'badge-app--gray'}" 
                                            onclick="toggleStatus(${student.id}, '${student.status}')" title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª">
                                        <span class="status-dot ${student.status === 'active' ? 'status-dot--active' : 'status-dot--inactive'}"></span>
                                        ${student.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                                    </button>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btn-app btn-app--primary btn-app--sm" onclick="viewStudent(${student.id})" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn-app btn-app--warning btn-app--sm" onclick="editStudent(${student.id})" title="ÙˆÛŒØ±Ø§ÛŒØ´">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn-app btn-app--success btn-app--sm" onclick="renewStudent(${student.id})" title="ØªÙ…Ø¯ÛŒØ¯">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                        <button class="btn-app btn-app--danger btn-app--sm" onclick="deleteStudent(${student.id}, '${student.first_name} ${student.last_name}')" title="Ø­Ø°Ù">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // Pagination
                    const paginationContainer = document.getElementById('paginationContainer');
                    if (data.data.pagination.total_pages > 1) {
                        new Pagination('paginationContainer', page, data.data.pagination.total_pages, (newPage) => {
                            currentPage = newPage;
                            loadStudents(newPage, currentSearch);
                        });
                        paginationContainer.style.display = 'block';
                    } else {
                        paginationContainer.innerHTML = '';
                        paginationContainer.style.display = 'none';
                    }
                }
            } catch (error) {
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª', 'danger');
            }
        }

        // Search with debounce
        const searchDebounced = debounce((value) => {
            currentSearch = value;
            currentPage = 1;
            loadStudents(1, value);
        }, 500);

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchDebounced(e.target.value);
        });

        // Invoice modal
        function showInvoiceModal(invoiceId, invoiceNumber) {
            currentInvoiceId = invoiceId;
            document.getElementById('invoiceNumber').textContent = invoiceNumber;
            const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            modal.show();
        }

        document.getElementById('viewInvoiceBtn').addEventListener('click', () => {
            if (currentInvoiceId) {
                window.open(`invoice.html?id=${currentInvoiceId}`, '_blank');
            }
        });

        document.getElementById('shareWhatsAppBtn').addEventListener('click', async () => {
            if (currentInvoiceId) {
                try {
                    const result = await APIClient.post(`invoices.php?id=${currentInvoiceId}&action=whatsapp`, { method: 'link' });
                    if (result.success && result.data.whatsapp_link) {
                        window.open(result.data.whatsapp_link, '_blank');
                    }
                } catch (error) {
                    showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© ÙˆØ§ØªØ³Ø§Ù¾', 'danger');
                }
            }
        });

        function viewStudent(id) {
            window.location.href = `student-detail.html?id=${id}`;
        }

        async function renewStudent(id) {
            const feeAmount = prompt('Ù…Ø¨Ù„Øº Ø­Ù‚â€ŒØ§Ù„Ø§Ø´ØªØ±Ø§Ú© Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
            if (feeAmount) {
                try {
                    const result = await APIClient.post(`students.php?id=${id}&action=renew`, { fee_amount: parseFloat(feeAmount) });
                    if (result.success) {
                        showAlert('ØªÙ…Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
                        showInvoiceModal(result.data.invoice_id, result.data.invoice_number);
                    }
                } catch (error) {
                    showAlert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯', 'danger');
                }
            }
        }

        // Edit student
        async function editStudent(id) {
            try {
                const result = await APIClient.get(`students.php?id=${id}`);
                if (result.success) {
                    const student = result.data;
                    document.getElementById('editStudentId').value = student.id;
                    document.getElementById('editFirstName').value = student.first_name || '';
                    document.getElementById('editLastName').value = student.last_name || '';
                    document.getElementById('editFatherName').value = student.father_name || '';
                    document.getElementById('editContactNumber').value = student.contact_number || '';
                    document.getElementById('editStatus').value = student.status || 'active';
                    document.getElementById('editNotes').value = student.notes || '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                    modal.show();
                }
            } catch (error) {
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²', 'danger');
            }
        }

        // Save edit
        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveEditBtn');
            const studentId = document.getElementById('editStudentId').value;
            
            // Validate
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const contactNumber = document.getElementById('editContactNumber').value.trim();
            
            // Clear previous validation
            document.querySelectorAll('#editStudentForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            let hasError = false;
            if (!firstName) {
                document.getElementById('editFirstName').classList.add('is-invalid');
                hasError = true;
            }
            if (!lastName) {
                document.getElementById('editLastName').classList.add('is-invalid');
                hasError = true;
            }
            if (contactNumber && !/^0[0-9]{9}$/.test(contactNumber)) {
                document.getElementById('editContactNumber').classList.add('is-invalid');
                hasError = true;
            }
            
            if (hasError) return;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-app spinner-app--sm"></span> Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            
            try {
                const result = await APIClient.put(`students.php?id=${studentId}`, {
                    first_name: firstName,
                    last_name: lastName,
                    father_name: document.getElementById('editFatherName').value.trim(),
                    contact_number: contactNumber,
                    status: document.getElementById('editStatus').value,
                    notes: document.getElementById('editNotes').value.trim()
                });
                
                if (result.success) {
                    showAlert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                    loadStudents(currentPage, currentSearch);
                }
            } catch (error) {
                showAlert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
            }
        });

        // Delete student with confirmation
        function deleteStudent(id, name) {
            showConfirmModal(
                'Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²',
                `Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù "${name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.`,
                async () => {
                    try {
                        const result = await APIClient.delete(`students.php?id=${id}`);
                        if (result.success) {
                            showAlert('Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
                            loadStudents(currentPage, currentSearch);
                        }
                    } catch (error) {
                        showAlert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²', 'danger');
                    }
                }
            );
        }

        // Toggle status
        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            try {
                const result = await APIClient.put(`students.php?id=${id}`, { status: newStatus });
                if (result.success) {
                    showAlert(`ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ "${newStatus === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}" ØªØºÛŒÛŒØ± Ú©Ø±Ø¯`, 'success');
                    loadStudents(currentPage, currentSearch);
                }
            } catch (error) {
                showAlert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª', 'danger');
            }
        }

        // Confirmation modal helper
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').innerHTML = `<i class="bi bi-exclamation-triangle text-warning"></i> ${title}`;
            document.getElementById('confirmModalMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmModalBtn');
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            
            newBtn.addEventListener('click', async () => {
                newBtn.disabled = true;
                newBtn.innerHTML = '<span class="spinner-app spinner-app--sm"></span>';
                await onConfirm();
                newBtn.disabled = false;
                newBtn.innerHTML = 'ØªØ£ÛŒÛŒØ¯';
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            });
            
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        // Select all checkbox
        document.getElementById('selectAll').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateBulkActions();
        });

        // Update bulk actions visibility
        function updateBulkActions() {
            const checked = document.querySelectorAll('.student-checkbox:checked').length;
            document.getElementById('bulkActions').style.display = checked > 0 ? 'flex' : 'none';
        }

        // Delegate checkbox change events
        document.getElementById('studentsTableBody').addEventListener('change', (e) => {
            if (e.target.classList.contains('student-checkbox')) {
                updateBulkActions();
            }
        });

        // Bulk delete
        document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.dataset.id);
            if (selected.length === 0) return;
            
            showConfirmModal(
                'Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡ÛŒ',
                `Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù ${selected.length} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`,
                async () => {
                    let successCount = 0;
                    for (const id of selected) {
                        try {
                            await APIClient.delete(`students.php?id=${id}`);
                            successCount++;
                        } catch (e) { /* continue */ }
                    }
                    showAlert(`${successCount} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø­Ø°Ù Ø´Ø¯`, 'success');
                    loadStudents(currentPage, currentSearch);
                }
            );
        });

        // Search clear button
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        
        searchInput.addEventListener('input', () => {
            searchClear.style.display = searchInput.value ? 'flex' : 'none';
        });
        
        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchClear.style.display = 'none';
            currentSearch = '';
            loadStudents(1, '');
        });

        // Mobile sidebar toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
        }

        // Photo upload with progress
        async function uploadPhotoWithProgress(file) {
            return new Promise((resolve, reject) => {
                const progressContainer = document.getElementById('photoProgress');
                const progressBar = document.getElementById('photoProgressBar');
                const progressText = document.getElementById('photoProgressText');
                
                progressContainer.style.display = 'flex';
                
                const xhr = new XMLHttpRequest();
                const formData = new FormData();
                formData.append('file', file);
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });
                
                xhr.addEventListener('load', () => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success) {
                                resolve(data.data.file_path);
                            } else {
                                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: ' + (data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'danger');
                                resolve(null);
                            }
                        } catch (e) {
                            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±', 'danger');
                            resolve(null);
                        }
                    } else {
                        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³', 'danger');
                        resolve(null);
                    }
                });
                
                xhr.addEventListener('error', () => {
                    progressContainer.style.display = 'none';
                    showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'danger');
                    resolve(null);
                });
                
                xhr.open('POST', API_BASE + 'upload.php?type=photo');
                xhr.withCredentials = true;
                xhr.send(formData);
            });
        }

        // Photo drag and drop
        const dropzone = document.getElementById('photoDropzone');
        const photoInput = document.getElementById('photoUpload');
        const photoPreview = document.getElementById('photoPreview');
        const photoPreviewImg = document.getElementById('photoPreviewImg');
        
        // Click to select
        dropzone.addEventListener('click', () => photoInput.click());
        
        // Drag events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'));
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'));
        });
        
        // Handle drop
        dropzone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handlePhotoSelect(files[0]);
            }
        });
        
        // Handle file input change
        photoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePhotoSelect(e.target.files[0]);
            }
        });
        
        // Handle photo selection
        function handlePhotoSelect(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAlert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'danger');
                return;
            }
            
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯', 'danger');
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                photoPreviewImg.src = e.target.result;
                photoPreview.style.display = 'block';
                dropzone.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // Update file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            photoInput.files = dataTransfer.files;
        }
        
        // Remove photo
        document.getElementById('removePhoto').addEventListener('click', () => {
            photoInput.value = '';
            photoPreview.style.display = 'none';
            dropzone.style.display = 'flex';
            photoPreviewImg.src = '';
        });

        // Initialize
        loadFormData();
        loadStudents();
        initDarkMode();
    </script>
</body>
</html>
