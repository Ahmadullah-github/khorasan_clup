<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø±Ø¨ÛŒ - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="vendor/bootstrap/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        .coach-header {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            color: white;
            margin-bottom: var(--space-6);
        }
        .coach-avatar {
            width: 80px; height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-xl);
            display: flex; align-items: center; justify-content: center;
            font-size: 36px;
        }
        .coach-name { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); }
        @media (max-width: 767px) { .stats-grid { grid-template-columns: 1fr; } }
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .stat-card-icon { font-size: 32px; margin-bottom: var(--space-3); }
        .stat-card-value { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); }
        .stat-card-label { font-size: var(--font-size-sm); color: var(--text-secondary); }
        .stat-card--students .stat-card-value { color: var(--color-primary-600); }
        .stat-card--registrations .stat-card-value { color: var(--color-success-600); }
        .stat-card--revenue .stat-card-value { color: #6366f1; }
        .time-slot-tags { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-2); }
        .time-slot-tag { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: var(--radius-full); font-size: var(--font-size-sm); }
    </style>
</head>
<body>
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html"><span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</a>
        <div class="navbar-actions">
            <a href="coaches.html" class="btn-app btn-app--secondary btn-app--sm"><i class="bi bi-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons"><span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span><span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span></span>
                <span class="theme-switch-slider"></span>
            </button>
        </div>
    </nav>
    <main class="app-main" style="margin-right: 0;">
        <div class="container-app" id="coachDetail">
            <div class="text-center py-5"><div class="spinner-app mx-auto"></div></div>
        </div>
    </main>
    <script src="vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/app-settings.js"></script>
    <script src="js/jalali.js"></script>
    <script>
        if (!checkAuth()) window.location.href = 'login.html';
        const coachId = new URLSearchParams(window.location.search).get('id');

        const contractTypeLabels = {
            'percentage': 'ğŸ“Š Ø¯Ø±ØµØ¯ÛŒ',
            'salary': 'ğŸ’° Ø­Ù‚ÙˆÙ‚ Ø«Ø§Ø¨Øª',
            'hybrid': 'âš–ï¸ ØªØ±Ú©ÛŒØ¨ÛŒ'
        };

        const statusLabels = {
            'active': { label: 'ÙØ¹Ø§Ù„', class: 'badge-app--success' },
            'inactive': { label: 'ØºÛŒØ±ÙØ¹Ø§Ù„', class: 'badge-app--danger' },
            'on_leave': { label: 'Ù…Ø±Ø®ØµÛŒ', class: 'badge-app--warning' }
        };

        async function loadCoachDetail() {
            try {
                const data = await APIClient.get(`coaches.php?id=${coachId}`);
                if (data.success) {
                    const c = data.data;
                    const statusInfo = statusLabels[c.status] || statusLabels['active'];
                    const photoHtml = c.photo_path 
                        ? `<img src="${c.photo_path}" class="coach-avatar" style="object-fit:cover;">`
                        : `<div class="coach-avatar">ğŸ…</div>`;
                    
                    document.getElementById('coachDetail').innerHTML = `
                        <div class="coach-header animate-slideUp">
                            <div class="d-flex align-items-center gap-4 flex-wrap">
                                ${photoHtml}
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="coach-name">${c.first_name} ${c.last_name}</span>
                                        <span class="badge-app ${statusInfo.class}">${statusInfo.label}</span>
                                    </div>
                                    ${c.phone ? `<div class="mb-2"><i class="bi bi-telephone"></i> ${c.phone}</div>` : ''}
                                    <div class="time-slot-tags">${c.time_slots.map(ts => `<span class="time-slot-tag">${ts.name}</span>`).join('')}</div>
                                </div>
                                <div>
                                    <a href="coach-form.html?id=${c.id}" class="btn-app btn-app--secondary">
                                        <i class="bi bi-pencil"></i> ÙˆÛŒØ±Ø§ÛŒØ´
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-grid animate-slideUp" style="animation-delay: 100ms;">
                            <div class="stat-card stat-card--students">
                                <div class="stat-card-icon">ğŸ‘¥</div>
                                <div class="stat-card-value">${c.statistics?.student_count || 0}</div>
                                <div class="stat-card-label">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div>
                            </div>
                            <div class="stat-card stat-card--registrations">
                                <div class="stat-card-icon">ğŸ“</div>
                                <div class="stat-card-value">${c.statistics?.registration_count || 0}</div>
                                <div class="stat-card-label">ØªØ¹Ø¯Ø§Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</div>
                            </div>
                            <div class="stat-card stat-card--revenue">
                                <div class="stat-card-icon">ğŸ’°</div>
                                <div class="stat-card-value">${formatCurrency(c.statistics?.total_fees || 0)}</div>
                                <div class="stat-card-label">Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯</div>
                            </div>
                        </div>
                        
                        <!-- Contract Info Card -->
                        <div class="card-app mt-4 animate-slideUp" style="animation-delay: 150ms;">
                            <div class="card-app-header">
                                <h2 class="card-app-title"><i class="bi bi-file-earmark-text"></i> Ø¬Ø²Ø¦ÛŒØ§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h2>
                            </div>
                            <div class="card-app-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="text-muted small">Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</div>
                                        <div class="fw-semibold">${contractTypeLabels[c.contract_type] || c.contract_type}</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-muted small">Ø¯Ø±ØµØ¯</div>
                                        <div class="fw-semibold text-primary">${c.percentage_rate || 0}%</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-muted small">Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡</div>
                                        <div class="fw-semibold text-success">${formatCurrency(c.monthly_salary || 0)}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted small">Ø´Ø±ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</div>
                                        <div class="fw-semibold">${c.contract_start_jalali ? formatJalaliDate(c.contract_start_jalali) : '-'}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted small">Ù¾Ø§ÛŒØ§Ù† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</div>
                                        <div class="fw-semibold">${c.contract_end_jalali ? formatJalaliDate(c.contract_end_jalali) : 'Ø¨Ø¯ÙˆÙ† Ù¾Ø§ÛŒØ§Ù†'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- General Info Card -->
                        <div class="card-app mt-4 animate-slideUp" style="animation-delay: 200ms;">
                            <div class="card-app-header"><h2 class="card-app-title"><i class="bi bi-info-circle"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ</h2></div>
                            <div class="card-app-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="text-muted small">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</div>
                                        <div class="fw-semibold">${formatJalaliDate(c.created_at_jalali)}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted small">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</div>
                                        <div class="fw-semibold">${c.notes || '-'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contract History Card -->
                        <div class="card-app mt-4 animate-slideUp" style="animation-delay: 250ms;">
                            <div class="card-app-header">
                                <h2 class="card-app-title"><i class="bi bi-clock-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h2>
                            </div>
                            <div class="card-app-body p-0">
                                <div id="contractHistoryContainer">
                                    <div class="text-center py-4"><div class="spinner-app mx-auto"></div></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Load contract history
                    loadContractHistory();
                }
            } catch (error) { 
                notify.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª'); 
                console.error(error);
            }
        }

        async function loadContractHistory() {
            try {
                const data = await APIClient.get('coaches.php', { id: coachId, action: 'contract-history' });
                const container = document.getElementById('contractHistoryContainer');
                
                if (data.success && data.data.history && data.data.history.length > 0) {
                    container.innerHTML = `
                        <table class="table-app">
                            <thead>
                                <tr>
                                    <th>ØªØ§Ø±ÛŒØ®</th>
                                    <th>Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
                                    <th>Ø¯Ø±ØµØ¯</th>
                                    <th>Ø­Ù‚ÙˆÙ‚</th>
                                    <th>Ø¯ÙˆØ±Ù‡</th>
                                    <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                                    <th>Ø«Ø¨Øª ØªÙˆØ³Ø·</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.history.map(h => `
                                    <tr>
                                        <td>${formatJalaliDate(h.created_at_jalali)}</td>
                                        <td>${contractTypeLabels[h.contract_type] || h.contract_type}</td>
                                        <td><span class="text-primary">${h.percentage_rate || 0}%</span></td>
                                        <td><span class="text-success">${formatCurrency(h.monthly_salary || 0)}</span></td>
                                        <td>
                                            ${h.start_date_jalali ? formatJalaliDate(h.start_date_jalali) : '-'}
                                            ${h.end_date_jalali ? ` ØªØ§ ${formatJalaliDate(h.end_date_jalali)}` : ''}
                                        </td>
                                        <td>${h.notes || '-'}</td>
                                        <td>${h.created_by_name || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="table-empty">
                            <div class="table-empty-icon">ğŸ“‹</div>
                            <div class="table-empty-text">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading contract history:', error);
                document.getElementById('contractHistoryContainer').innerHTML = `
                    <div class="alert-app alert-app--danger m-3">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡</div>
                `;
            }
        }

        loadCoachDetail();
        initDarkMode();
    </script>
</body>
</html>
