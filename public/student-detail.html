<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="vendor/bootstrap/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        .profile-page { max-width: 800px; margin: 0 auto; padding: 16px; }
        
        /* Header */
        .profile-card {
            background: linear-gradient(135deg, #4F8EF7 0%, #2D6BE0 100%);
            border-radius: 20px;
            padding: 28px;
            color: white;
            margin-bottom: 20px;
        }
        .profile-top {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }
        .profile-photo {
            width: 85px;
            height: 85px;
            background: rgba(255,255,255,0.2);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
        }
        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .profile-father { opacity: 0.9; font-size: 14px; margin-bottom: 10px; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 13px;
        }
        
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-box {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }
        .stat-value { font-size: 22px; font-weight: 700; }
        .stat-label { font-size: 11px; opacity: 0.85; }
        
        /* Section */
        .section {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary-600);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Info List */
        .info-list { margin: 0; padding: 0; list-style: none; }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-secondary);
        }
        .info-item:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); font-size: 13px; }
        .info-value { font-weight: 500; color: var(--text-primary); font-size: 13px; }
        
        /* Buttons */
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-action {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 9px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: transform 0.12s, opacity 0.12s;
        }
        .btn-action:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-action.primary { background: var(--color-primary-500); color: white; }
        .btn-action.success { background: #25D366; color: white; }
        .btn-action.secondary { background: var(--color-gray-100); color: var(--color-gray-700); }
        
        /* Registration */
        .reg-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }
        .reg-item.active { border-right: 3px solid var(--color-success-500); }
        .reg-item.expired { opacity: 0.7; }
        .reg-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .reg-coach { font-weight: 600; color: var(--text-primary); font-size: 14px; }
        .reg-time { font-size: 12px; color: var(--text-secondary); margin-top: 3px; }
        .reg-status { font-size: 11px; padding: 3px 8px; border-radius: 5px; font-weight: 500; }
        .reg-status.active { background: var(--color-success-100); color: var(--color-success-700); }
        .reg-status.expired { background: var(--color-gray-100); color: var(--color-gray-600); }
        
        .reg-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-secondary);
        }
        .reg-detail { text-align: center; }
        .reg-detail-label { font-size: 10px; color: var(--text-tertiary); margin-bottom: 2px; }
        .reg-detail-value { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .reg-detail-value.amount { color: var(--color-success-600); }
        
        .reg-footer { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-secondary); }
        
        /* Empty & Loading */
        .empty-box { text-align: center; padding: 32px 16px; color: var(--text-secondary); }
        .empty-icon { font-size: 40px; opacity: 0.4; margin-bottom: 8px; }
        .loading-box { text-align: center; padding: 50px 16px; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.25s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 576px) {
            .profile-card { padding: 20px; }
            .profile-top { flex-direction: column; text-align: center; }
            .profile-photo { width: 70px; height: 70px; }
            .stats-row { gap: 6px; }
            .stat-box { padding: 10px; }
            .stat-value { font-size: 18px; }
            .reg-details { grid-template-columns: 1fr; gap: 8px; }
        }
    </style>
</head>
<body>
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html"><span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</a>
        <div class="navbar-actions">
            <a href="students.html" class="btn-app btn-app--secondary btn-app--sm">
                <i class="bi bi-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
            </a>
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons">
                    <span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span>
                    <span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span>
                </span>
                <span class="theme-switch-slider"></span>
            </button>
        </div>
    </nav>
    
    <main class="app-main" style="margin-right: 0;">
        <div class="profile-page" id="pageContent">
            <div class="loading-box">
                <div class="spinner-app mx-auto"></div>
            </div>
        </div>
    </main>

    <script src="vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/app-settings.js"></script>
    <script src="js/jalali.js"></script>

    <script>
        (function() {
            if (!checkAuth()) {
                window.location.href = 'login.html';
                return;
            }
            
            var studentId = new URLSearchParams(window.location.search).get('id');
            if (!studentId) {
                window.location.href = 'students.html';
                return;
            }

            loadProfile();

            function loadProfile() {
                Promise.all([
                    APIClient.get('students.php?id=' + studentId),
                    APIClient.get('students.php?id=' + studentId + '&action=registrations')
                ]).then(function(results) {
                    var studentRes = results[0];
                    var regRes = results[1];
                    
                    if (!studentRes.success || !studentRes.data) {
                        showError('Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ÛŒØ§ÙØª Ù†Ø´Ø¯');
                        return;
                    }
                    
                    var student = studentRes.data;
                    var regs = (regRes.success && regRes.data) ? regRes.data : [];
                    
                    render(student, regs);
                }).catch(function(err) {
                    console.error('Load error:', err);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
                });
            }

            function showError(msg) {
                document.getElementById('pageContent').innerHTML = 
                    '<div class="empty-box">' +
                    '<div class="empty-icon">âš ï¸</div>' +
                    '<div>' + msg + '</div>' +
                    '<a href="students.html" class="btn-action primary" style="margin-top:16px;display:inline-flex;">' +
                    '<i class="bi bi-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</a></div>';
            }

            function render(s, regs) {
                var activeCount = 0;
                var totalPaid = 0;
                
                for (var i = 0; i < regs.length; i++) {
                    if (regs[i].status === 'active') activeCount++;
                    totalPaid += parseFloat(regs[i].fee_amount) || 0;
                }
                
                // Get the first registration date (earliest) for membership date
                var membershipDate = s.created_at_jalali;
                if (regs.length > 0) {
                    // Sort by registration date to find the earliest
                    var sortedRegs = regs.slice().sort(function(a, b) {
                        var dateA = a.registration_date_jalali || '';
                        var dateB = b.registration_date_jalali || '';
                        return dateA.localeCompare(dateB);
                    });
                    membershipDate = sortedRegs[0].registration_date_jalali || s.created_at_jalali;
                }
                
                // Get initials for avatar fallback
                var initials = '';
                if (s.first_name) initials += s.first_name.charAt(0);
                if (s.last_name) initials += s.last_name.charAt(0);
                
                // Format phone for WhatsApp
                var waPhone = '';
                if (s.contact_number) {
                    waPhone = s.contact_number.replace(/[^0-9]/g, '');
                    if (waPhone.charAt(0) === '0') {
                        waPhone = '93' + waPhone.substring(1);
                    }
                }
                
                var html = '';
                
                // Profile Card
                html += '<div class="profile-card fade-in">';
                html += '<div class="profile-top">';
                html += '<div class="profile-photo">';
                if (s.photo_path) {
                    // photo_path is stored as "assets/uploads/photos/filename.jpg"
                    html += '<img src="' + s.photo_path + '" alt="' + escapeHtml(s.first_name) + '" onerror="this.parentElement.innerHTML=\'' + (initials || 'ğŸ‘¤') + '\'">';
                } else {
                    html += initials || 'ğŸ‘¤';
                }
                html += '</div>';
                html += '<div class="profile-info">';
                html += '<div class="profile-name">' + escapeHtml(s.first_name) + ' ' + escapeHtml(s.last_name) + '</div>';
                html += '<div class="profile-father"><i class="bi bi-person"></i> ÙØ±Ø²Ù†Ø¯ ' + escapeHtml(s.father_name || '---') + '</div>';
                html += '<span class="status-badge">';
                html += '<i class="bi bi-' + (s.status === 'active' ? 'check-circle' : 'x-circle') + '"></i> ';
                html += (s.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„');
                html += '</span>';
                html += '</div></div>';
                
                // Stats
                html += '<div class="stats-row">';
                html += '<div class="stat-box"><div class="stat-value">' + regs.length + '</div><div class="stat-label">Ú©Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + activeCount + '</div><div class="stat-label">ÙØ¹Ø§Ù„</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + formatNumber(totalPaid) + '</div><div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</div></div>';
                html += '</div></div>';
                
                // Contact Info
                html += '<div class="section fade-in">';
                html += '<div class="section-title"><i class="bi bi-person-lines-fill"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³</div>';
                html += '<ul class="info-list">';
                html += '<li class="info-item">';
                html += '<span class="info-label"><i class="bi bi-telephone"></i> Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</span>';
                html += '<span class="info-value">' + escapeHtml(s.contact_number || '---') + '</span>';
                html += '</li>';
                html += '<li class="info-item">';
                html += '<span class="info-label"><i class="bi bi-calendar"></i> ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª</span>';
                html += '<span class="info-value">' + formatJalaliDate(membershipDate) + '</span>';
                html += '</li>';
                if (s.notes) {
                    html += '<li class="info-item">';
                    html += '<span class="info-label"><i class="bi bi-sticky"></i> ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</span>';
                    html += '<span class="info-value">' + escapeHtml(s.notes) + '</span>';
                    html += '</li>';
                }
                html += '</ul></div>';
                
                // Action Buttons
                html += '<div class="action-btns fade-in">';
                html += '<a href="coach-form.html?student_id=' + s.id + '" class="btn-action primary">';
                html += '<i class="bi bi-plus-circle"></i> Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯</a>';
                if (s.contact_number) {
                    html += '<a href="https://wa.me/' + waPhone + '" target="_blank" class="btn-action success">';
                    html += '<i class="bi bi-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ù¾</a>';
                    html += '<a href="tel:' + s.contact_number + '" class="btn-action secondary">';
                    html += '<i class="bi bi-telephone"></i> ØªÙ…Ø§Ø³</a>';
                }
                html += '</div>';
                
                // Registrations
                html += '<div class="section fade-in">';
                html += '<div class="section-title"><i class="bi bi-clock-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</div>';
                
                if (regs.length === 0) {
                    html += '<div class="empty-box"><div class="empty-icon">ğŸ“‹</div><div>Ù‡Ù†ÙˆØ² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡</div></div>';
                } else {
                    // Sort: active first, then by date desc
                    regs.sort(function(a, b) {
                        if (a.status === 'active' && b.status !== 'active') return -1;
                        if (a.status !== 'active' && b.status === 'active') return 1;
                        var dateA = a.registration_date_jalali || '';
                        var dateB = b.registration_date_jalali || '';
                        return dateB.localeCompare(dateA);
                    });
                    
                    for (var j = 0; j < regs.length; j++) {
                        var r = regs[j];
                        var isActive = r.status === 'active';
                        
                        html += '<div class="reg-item ' + (isActive ? 'active' : 'expired') + '">';
                        html += '<div class="reg-top">';
                        html += '<div>';
                        html += '<div class="reg-coach"><i class="bi bi-person-badge text-primary"></i> ';
                        html += escapeHtml(r.coach_first_name) + ' ' + escapeHtml(r.coach_last_name) + '</div>';
                        html += '<div class="reg-time"><i class="bi bi-clock"></i> ' + escapeHtml(r.time_slot_name) + '</div>';
                        html += '</div>';
                        html += '<span class="reg-status ' + (isActive ? 'active' : 'expired') + '">';
                        html += (isActive ? 'ÙØ¹Ø§Ù„' : 'Ù…Ù†Ù‚Ø¶ÛŒ') + '</span>';
                        html += '</div>';
                        
                        html += '<div class="reg-details">';
                        html += '<div class="reg-detail">';
                        html += '<div class="reg-detail-label">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</div>';
                        html += '<div class="reg-detail-value">' + formatJalaliDate(r.registration_date_jalali) + '</div>';
                        html += '</div>';
                        html += '<div class="reg-detail">';
                        html += '<div class="reg-detail-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</div>';
                        html += '<div class="reg-detail-value">' + formatJalaliDate(r.end_date_jalali) + '</div>';
                        html += '</div>';
                        html += '<div class="reg-detail">';
                        html += '<div class="reg-detail-label">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</div>';
                        html += '<div class="reg-detail-value amount">' + formatCurrency(r.fee_amount) + '</div>';
                        html += '</div>';
                        html += '</div>';
                        
                        if (r.invoice_id) {
                            html += '<div class="reg-footer">';
                            html += '<a href="invoice.html?id=' + r.invoice_id + '" target="_blank" class="btn-action primary" style="padding:6px 12px;font-size:12px;">';
                            html += '<i class="bi bi-receipt"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±</a>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                }
                html += '</div>';
                
                document.getElementById('pageContent').innerHTML = html;
            }
            
            function escapeHtml(text) {
                if (!text) return '';
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            initDarkMode();
        })();
    </script>
</body>
</html>
