<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ - Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        /* Special styles for Accounting Page */
        .accounting-hero {
            background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-800) 50%, #1e1b4b 100%);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }
        .accounting-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        .accounting-hero::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(99,102,241,0.3) 0%, transparent 70%);
            border-radius: 50%;
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: white;
            margin-bottom: var(--space-2);
        }
        .hero-subtitle { color: rgba(255,255,255,0.7); font-size: var(--font-size-base); }

        /* Filter Card */
        .filter-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            display: flex;
            gap: var(--space-4);
            align-items: flex-end;
            flex-wrap: wrap;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 2;
            margin-top: calc(-1 * var(--space-10));
            margin-left: var(--space-6);
            margin-right: var(--space-6);
        }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
        .calculate-btn {
            min-width: 160px;
            height: 48px;
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            transition: all var(--transition-base);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
        }
        .calculate-btn:active { transform: translateY(0); }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        @media (max-width: 991px) { .summary-grid { grid-template-columns: 1fr; } }
        .summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all var(--transition-base);
        }
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        .summary-card--income { border-top: 4px solid var(--color-success-500); }
        .summary-card--expense { border-top: 4px solid var(--color-danger-500); }
        .summary-card--net { border-top: 4px solid var(--color-primary-500); }
        .summary-card-icon {
            width: 56px; height: 56px;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: var(--space-4);
        }
        .summary-card--income .summary-card-icon { background: var(--color-success-100); color: var(--color-success-600); }
        .summary-card--expense .summary-card-icon { background: var(--color-danger-100); color: var(--color-danger-600); }
        .summary-card--net .summary-card-icon { background: var(--color-primary-100); color: var(--color-primary-600); }
        [data-theme="dark"] .summary-card--income .summary-card-icon { background: rgba(16,185,129,0.2); }
        [data-theme="dark"] .summary-card--expense .summary-card-icon { background: rgba(239,68,68,0.2); }
        [data-theme="dark"] .summary-card--net .summary-card-icon { background: rgba(59,130,246,0.2); }
        .summary-card-label { font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-1); }
        .summary-card-value { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); margin-bottom: var(--space-3); }
        .summary-card--income .summary-card-value { color: var(--color-success-600); }
        .summary-card--expense .summary-card-value { color: var(--color-danger-600); }
        .summary-card--net .summary-card-value { color: var(--color-primary-600); }
        .summary-card-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-sm);
            color: var(--color-primary-600);
            text-decoration: none;
            font-weight: var(--font-weight-medium);
        }
        .summary-card-link:hover { text-decoration: underline; }

        /* Coach Payout Table */
        .payout-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .payout-header {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            padding: var(--space-5) var(--space-6);
            color: white;
        }
        .payout-header h2 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        .payout-table { width: 100%; border-collapse: collapse; }
        .payout-table thead th {
            background: var(--bg-secondary);
            padding: var(--space-4);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            text-align: right;
            border-bottom: 2px solid var(--border-color);
        }
        .payout-table tbody td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-color-light);
            vertical-align: middle;
        }
        .payout-table tbody tr:hover { background: var(--bg-hover); }
        .payout-table tbody tr:last-child td { border-bottom: none; }
        .coach-name { font-weight: var(--font-weight-semibold); color: var(--text-primary); }
        .time-slot-tags { display: flex; flex-wrap: wrap; gap: var(--space-1); }
        .time-slot-tag {
            background: var(--color-primary-100);
            color: var(--color-primary-700);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }
        [data-theme="dark"] .time-slot-tag { background: rgba(99,102,241,0.2); color: #a5b4fc; }
        .payout-total {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-success-600);
        }
        /* Enhanced Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-md);
            display: inline-block;
        }
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-card {
            position: relative;
            overflow: hidden;
        }
        .loading-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
            z-index: 1;
        }
        [data-theme="dark"] .loading-card::before {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--color-primary-100);
            border-radius: 2px;
            overflow: hidden;
            margin: var(--space-3) 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary-500), var(--color-primary-600));
            border-radius: 2px;
            animation: progress-indeterminate 2s infinite;
        }
        @keyframes progress-indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .loading-spinner {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }
        .loading-spinner .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-primary-200);
            border-top: 2px solid var(--color-primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .calculation-progress {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        .calculation-progress.show { 
            display: block; 
            opacity: 1;
            transform: translateY(0);
        }
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 12px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--color-primary-200);
            z-index: 0;
            transition: background 0.3s ease;
        }
        .progress-step.completed::after { background: var(--color-primary-500); }
        .progress-step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-primary-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            position: relative;
            z-index: 1;
            margin-bottom: var(--space-1);
            transition: all 0.3s ease;
        }
        .progress-step.active .progress-step-icon {
            background: var(--color-primary-500);
            animation: pulse 2s infinite;
        }
        .progress-step.completed .progress-step-icon { 
            background: var(--color-success-500);
            transform: scale(1.1);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .progress-step-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-align: center;
            transition: all 0.3s ease;
        }
        .progress-step.active .progress-step-label { 
            color: var(--color-primary-600); 
            font-weight: var(--font-weight-medium); 
        }
        .progress-step.completed .progress-step-label { 
            color: var(--color-success-600); 
        }

        .table-skeleton {
            animation: skeleton-loading 1.5s infinite;
        }
        .table-skeleton td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-color-light);
        }
        .skeleton-text {
            height: 16px;
            background: var(--color-primary-100);
            border-radius: var(--radius-sm);
            margin: 2px 0;
        }
        [data-theme="dark"] .skeleton-text {
            background: #374151;
        }
        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        /* Data Visualization Charts */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: var(--space-6);
        }
        .chart-header {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            padding: var(--space-4) var(--space-5);
            color: white;
        }
        .chart-header h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .chart-content {
            padding: var(--space-5);
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-bottom: var(--space-4);
        }
        .chart-wrapper.small {
            height: 200px;
        }
        .chart-wrapper canvas {
            max-height: 100%;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        @media (max-width: 991px) { 
            .charts-grid { 
                grid-template-columns: 1fr; 
            } 
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
            margin-top: var(--space-3);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-sm);
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
        }
        .trend-indicator.positive {
            color: var(--color-success-700);
            background: var(--color-success-100);
        }
        .trend-indicator.negative {
            color: var(--color-danger-700);
            background: var(--color-danger-100);
        }
        .trend-indicator.neutral {
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }
        [data-theme="dark"] .trend-indicator.positive {
            background: rgba(16,185,129,0.2);
            color: #6ee7b7;
        }
        [data-theme="dark"] .trend-indicator.negative {
            background: rgba(239,68,68,0.2);
            color: #fca5a5;
        }

        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border-color-light);
        }
        .chart-stat {
            text-align: center;
        }
        .chart-stat-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }
        .chart-stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: var(--space-1);
        }

        /* Animation classes */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slideUp {
            animation: slideUp 0.6s ease-out both;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Algorithm Info */
        .algorithm-info {
            background: linear-gradient(135deg, var(--color-primary-50) 0%, #ede9fe 100%);
            border: 1px solid var(--color-primary-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-top: var(--space-4);
        }
        [data-theme="dark"] .algorithm-info {
            background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.1) 100%);
            border-color: rgba(99,102,241,0.3);
        }
        .algorithm-info h4 {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary-700);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        [data-theme="dark"] .algorithm-info h4 { color: var(--color-primary-300); }
        .algorithm-info ul { margin: 0; padding-right: var(--space-5); }
        .algorithm-info li {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar-app">
        <a class="navbar-brand" href="index.html">
            <span class="navbar-brand-icon">ğŸ¤¸â€â™‚ï¸</span>
            Ú©Ù…Ù¾ Ø®Ø±Ø§Ø³Ø§Ù†
        </a>
        <ul class="navbar-nav-app">
            <li><a class="nav-link-app" href="index.html">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
            <li><a class="nav-link-app" href="students.html">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a></li>
            <li><a class="nav-link-app" href="coaches.html">Ù…Ø±Ø¨ÛŒØ§Ù†</a></li>
            <li><a class="nav-link-app" href="expenses.html">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a></li>
            <li><a class="nav-link-app" href="rent.html">Ø§Ø¬Ø§Ø±Ù‡</a></li>
            <li><a class="nav-link-app active" href="accounting.html">Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ</a></li>
            <li><a class="nav-link-app" href="reports.html">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a></li>
            <li id="adminNavItem" style="display: none;"><a class="nav-link-app" href="admin.html">Ù…Ø¯ÛŒØ±</a></li>
        </ul>
        <div class="navbar-actions">
            <button type="button" class="theme-switch" id="themeSwitch" title="ØªØºÛŒÛŒØ± ØªÙ…">
                <span class="theme-switch-icons">
                    <span class="theme-switch-icon theme-switch-icon--sun">â˜€ï¸</span>
                    <span class="theme-switch-icon theme-switch-icon--moon">ğŸŒ™</span>
                </span>
                <span class="theme-switch-slider"></span>
            </button>
            <div class="navbar-user">
                <span class="navbar-user-icon"><i class="bi bi-person"></i></span>
                <span id="userName"></span>
            </div>
            <button class="navbar-logout" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
        <button class="navbar-mobile-toggle" id="mobileMenuToggle"><i class="bi bi-list"></i></button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar-app" id="sidebar">
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="bi bi-grid-1x2 sidebar-nav-icon"></i>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></div>
            <div class="sidebar-section-title">Ù…Ø¯ÛŒØ±ÛŒØª</div>
            <div class="sidebar-nav-item"><a href="students.html" class="sidebar-nav-link"><i class="bi bi-people sidebar-nav-icon"></i>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a></div>
            <div class="sidebar-nav-item"><a href="coaches.html" class="sidebar-nav-link"><i class="bi bi-person-badge sidebar-nav-icon"></i>Ù…Ø±Ø¨ÛŒØ§Ù†</a></div>
            <div class="sidebar-section-title">Ù…Ø§Ù„ÛŒ</div>
            <div class="sidebar-nav-item"><a href="expenses.html" class="sidebar-nav-link"><i class="bi bi-cash-stack sidebar-nav-icon"></i>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a></div>
            <div class="sidebar-nav-item"><a href="rent.html" class="sidebar-nav-link"><i class="bi bi-house sidebar-nav-icon"></i>Ø§Ø¬Ø§Ø±Ù‡</a></div>
            <div class="sidebar-nav-item"><a href="accounting.html" class="sidebar-nav-link active"><i class="bi bi-calculator sidebar-nav-icon"></i>Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ</a></div>
            <div class="sidebar-nav-item"><a href="reports.html" class="sidebar-nav-link"><i class="bi bi-bar-chart sidebar-nav-icon"></i>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a></div>
            <div class="sidebar-section-title">Ø³ÛŒØ³ØªÙ…</div>
            <div class="sidebar-nav-item" id="adminSidebarItem" style="display: none;"><a href="admin.html" class="sidebar-nav-link"><i class="bi bi-gear sidebar-nav-icon"></i>Ù…Ø¯ÛŒØ±</a></div>
            <div class="sidebar-nav-item"><a href="#" class="sidebar-nav-link" onclick="logout()"><i class="bi bi-box-arrow-right sidebar-nav-icon"></i>Ø®Ø±ÙˆØ¬</a></div>
        </nav>
    </aside>
    
<!-- Main Content -->
    <main class="app-main">
        <div class="container-app">
            <!-- Hero Section -->
            <div class="accounting-hero animate-slideUp">
                <div class="hero-content">
                    <h1 class="hero-title">
                        <i class="bi bi-calculator me-2"></i>
                        Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†
                    </h1>
                </div>
            </div>

            <!-- Filter Card -->
            <div class="filter-card animate-slideUp" style="animation-delay: 100ms;">
                <div class="filter-group">
                    <label><i class="bi bi-calendar3 me-1"></i> Ù…Ø§Ù‡ (Ø¬Ù„Ø§Ù„ÛŒ)</label>
                    <select class="form-control-app form-select-app" id="monthSelect">
                        <option value="1">Ø­Ù…Ù„</option>
                        <option value="2">Ø«ÙˆØ±</option>
                        <option value="3">Ø¬ÙˆØ²Ø§</option>
                        <option value="4">Ø³Ø±Ø·Ø§Ù†</option>
                        <option value="5">Ø§Ø³Ø¯</option>
                        <option value="6">Ø³Ù†Ø¨Ù„Ù‡</option>
                        <option value="7">Ù…ÛŒØ²Ø§Ù†</option>
                        <option value="8">Ø¹Ù‚Ø±Ø¨</option>
                        <option value="9">Ù‚ÙˆØ³</option>
                        <option value="10">Ø¬Ø¯ÛŒ</option>
                        <option value="11">Ø¯Ù„Ùˆ</option>
                        <option value="12">Ø­ÙˆØª</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="bi bi-calendar-range me-1"></i> Ø³Ø§Ù„ (Ø¬Ù„Ø§Ù„ÛŒ)</label>
                    <input type="number" class="form-control-app" id="yearSelect" min="1380" max="1450">
                </div>
                <button class="calculate-btn" onclick="loadAccounting()">
                    <i class="bi bi-calculator"></i>
                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†
                </button>
            </div>

            <!-- Calculation Progress -->
            <div class="calculation-progress" id="calculationProgress">
                <div class="progress-steps">
                    <div class="progress-step" id="step1">
                        <div class="progress-step-icon">1</div>
                        <div class="progress-step-label">Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</div>
                    </div>
                    <div class="progress-step" id="step2">
                        <div class="progress-step-icon">2</div>
                        <div class="progress-step-label">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯</div>
                    </div>
                    <div class="progress-step" id="step3">
                        <div class="progress-step-icon">3</div>
                        <div class="progress-step-label">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†</div>
                    </div>
                    <div class="progress-step" id="step4">
                        <div class="progress-step-icon">4</div>
                        <div class="progress-step-label">ØªÚ©Ù…ÛŒÙ„ Ú¯Ø²Ø§Ø±Ø´</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="progressText">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</small>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid mt-6 animate-slideUp" style="animation-delay: 200ms;">
                <div class="summary-card summary-card--income">
                    <div class="summary-card-icon">ğŸ’°</div>
                    <div class="summary-card-label">Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„</div>
                    <div class="summary-card-value" id="totalIncome">
                        <div class="skeleton" style="width: 120px; height: 36px;"></div>
                    </div>
                    <div class="mt-2" id="incomeTrend">
                        <div class="skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                    <a href="#" class="summary-card-link" onclick="showBreakdown('income'); return false;">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="bi bi-arrow-left"></i>
                    </a>
                </div>
                <div class="summary-card summary-card--expense">
                    <div class="summary-card-icon">ğŸ“‰</div>
                    <div class="summary-card-label">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„</div>
                    <div class="summary-card-value" id="totalExpenses">
                        <div class="skeleton" style="width: 120px; height: 36px;"></div>
                    </div>
                    <div class="mt-2" id="expenseTrend">
                        <div class="skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                    <a href="#" class="summary-card-link" onclick="showBreakdown('expense'); return false;">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="bi bi-arrow-left"></i>
                    </a>
                </div>
                <div class="summary-card summary-card--net">
                    <div class="summary-card-icon">ğŸ“Š</div>
                    <div class="summary-card-label">Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ</div>
                    <div class="summary-card-value" id="netIncome">
                        <div class="skeleton" style="width: 120px; height: 36px;"></div>
                    </div>
                    <div class="mt-2" id="netTrend">
                        <div class="skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                </div>
            </div>

            <!-- Data Visualization Charts -->
            <div class="charts-grid animate-slideUp" style="animation-delay: 250ms;">
                <!-- Income vs Expenses Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="bi bi-bar-chart"></i> Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ø±Ø¢Ù…Ø¯ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡</h3>
                    </div>
                    <div class="chart-content">
                        <div class="chart-wrapper">
                            <canvas id="incomeExpenseChart"></canvas>
                        </div>
                        <div class="chart-stats" id="incomeExpenseStats">
                            <div class="chart-stat">
                                <div class="chart-stat-value" id="profitMargin">-</div>
                                <div class="chart-stat-label">Ø­Ø§Ø´ÛŒÙ‡ Ø³ÙˆØ¯ (%)</div>
                            </div>
                            <div class="chart-stat">
                                <div class="chart-stat-value" id="expenseRatio">-</div>
                                <div class="chart-stat-label">Ù†Ø³Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ (%)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income Distribution Pie Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="bi bi-pie-chart"></i> ØªÙˆØ²ÛŒØ¹ Ø¯Ø±Ø¢Ù…Ø¯</h3>
                    </div>
                    <div class="chart-content">
                        <div class="chart-wrapper small">
                            <canvas id="incomeDistributionChart"></canvas>
                        </div>
                        <div class="chart-legend" id="incomeDistributionLegend">
                            <!-- Legend items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coach Payments Chart -->
            <div class="chart-container animate-slideUp" style="animation-delay: 300ms;">
                <div class="chart-header">
                    <h3><i class="bi bi-people"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†</h3>
                </div>
                <div class="chart-content">
                    <div class="chart-wrapper">
                        <canvas id="coachPaymentsChart"></canvas>
                    </div>
                    <div class="chart-stats" id="coachPaymentStats">
                        <div class="chart-stat">
                            <div class="chart-stat-value" id="avgCoachPayment">-</div>
                            <div class="chart-stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª</div>
                        </div>
                        <div class="chart-stat">
                            <div class="chart-stat-value" id="totalCoaches">-</div>
                            <div class="chart-stat-label">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø¨ÛŒØ§Ù†</div>
                        </div>
                        <div class="chart-stat">
                            <div class="chart-stat-value" id="paymentEfficiency">-</div>
                            <div class="chart-stat-label">Ø¨Ø§Ø²Ø¯Ù‡ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª (%)</div>
                        </div>
                    </div>
                </div>
            <!-- Coach Payouts -->
            <div class="payout-card animate-slideUp" style="animation-delay: 350ms;">
                <div class="payout-header">
                    <h2><i class="bi bi-people"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†</h2>
                </div>
                <div class="table-responsive">
                    <table class="payout-table">
                        <thead>
                            <tr>
                                <th>Ù…Ø±Ø¨ÛŒ</th>
                                <th>Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
                                <th>Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ</th>
                                <th>Ø¯Ø±Ø¢Ù…Ø¯ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ·</th>
                                <th>Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="payoutsTableBody">
                            <!-- Skeleton Loading Rows -->
                            <tr class="table-skeleton">
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text long"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                            </tr>
                            <tr class="table-skeleton">
                                <td><div class="skeleton-text long"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                            </tr>
                            <tr class="table-skeleton">
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                                <td><div class="skeleton-text long"></div></td>
                                <td><div class="skeleton-text medium"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                                <td><div class="skeleton-text short"></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4">
                    <div class="algorithm-info">
                        <h4><i class="bi bi-lightbulb"></i> Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª</h4>
                        <ul>
                            <li><strong>Ø¯Ø±ØµØ¯ÛŒ:</strong> Ø¯Ø±Ø¢Ù…Ø¯ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ã— Ø¯Ø±ØµØ¯ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</li>
                            <li><strong>Ø­Ù‚ÙˆÙ‚ Ø«Ø§Ø¨Øª:</strong> Ù…Ø¨Ù„Øº Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø«Ø§Ø¨Øª</li>
                            <li><strong>ØªØ±Ú©ÛŒØ¨ÛŒ:</strong> Ø­Ù‚ÙˆÙ‚ Ø«Ø§Ø¨Øª + (Ø¯Ø±Ø¢Ù…Ø¯ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ã— Ø¯Ø±ØµØ¯)</li>
                            <li><strong>Ø¯Ø±Ø¢Ù…Ø¯ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ·:</strong> ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ØµØ¨Ø­/Ø´Ø§Ù… (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Camp Summary -->
            <div class="payout-card animate-slideUp mt-4" style="animation-delay: 400ms;">
                <div class="payout-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h2><i class="bi bi-building"></i> Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ Ú©Ù…Ù¾</h2>
                </div>
                <div class="p-4">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="text-muted small">Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div>
                            <div class="fs-4 fw-bold text-success" id="summaryTotalFees">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted small">Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†</div>
                            <div class="fs-4 fw-bold text-primary" id="summaryCoachPayments">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted small">Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</div>
                            <div class="fs-4 fw-bold text-danger" id="summaryExpenses">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted small">Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ Ú©Ù…Ù¾</div>
                            <div class="fs-4 fw-bold" id="summaryCampNet">-</div>
                        </div>
                    </div>
                    <div class="mt-3 p-3 rounded" style="background: var(--bg-secondary);">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            ÙØ±Ù…ÙˆÙ„: Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ Ú©Ù…Ù¾ = Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† - Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù† - Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                        </small>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/jalali.js"></script>

    <script>
        // Check auth
        const user = checkAuth();
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.username;
            if (user.role === 'admin') {
                document.getElementById('adminNavItem').style.display = 'block';
                document.getElementById('adminSidebarItem').style.display = 'block';
            }
        }

        let currentMonth = 0;
        let currentYear = 0;
        let charts = {}; // Store chart instances
        
        // Chart.js default configuration for RTL and Persian
        Chart.defaults.font.family = 'IRANSans, Tahoma, Arial, sans-serif';
        Chart.defaults.plugins.legend.rtl = true;
        Chart.defaults.plugins.tooltip.rtl = true;
        
        // Get badge color based on contract type
        function getContractTypeBadgeColor(contractType) {
            switch (contractType) {
                case 'percentage': return '#6366f1'; // indigo
                case 'salary': return '#10b981'; // green
                case 'hybrid': return '#f59e0b'; // amber
                default: return '#6b7280'; // gray
            }
        }

        // Set current Jalali month/year as default
        (function setDefaultDate() {
            const now = new Date();
            const jalali = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
            const parts = jalali.split('-');
            document.getElementById('monthSelect').value = parseInt(parts[1]);
            document.getElementById('yearSelect').value = parts[0];
        })();

        async function loadAccounting() {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            
            // Validate year input
            if (isNaN(year) || year < 1380 || year > 1450) {
                notify.validation('Ø³Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û±Û³Û¸Û° ØªØ§ Û±Û´ÛµÛ° Ø¨Ø§Ø´Ø¯', document.getElementById('yearSelect'));
                return;
            }
            
            currentMonth = month;
            currentYear = year;

            // Show calculation progress
            showCalculationProgress();

            // Disable button and show loading state
            const btn = document.querySelector('.calculate-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"><div class="spinner"></div>Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</div>';

            // Show skeleton loading in summary cards
            showSummarySkeletons();
            
            // Show skeleton loading in table
            showTableSkeletons();

            try {
                // Step 1: Data Collection
                updateProgressStep(1, 'active');
                updateProgressText('Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ùˆ Ù…Ø±Ø¨ÛŒØ§Ù†...');
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate delay

                // Step 2: Income Calculation
                updateProgressStep(1, 'completed');
                updateProgressStep(2, 'active');
                updateProgressText('Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§...');
                
                // Load net income
                const netIncomeData = await APIClient.get(`accounting.php?action=net-income&month=${month}&year=${year}`);
                if (netIncomeData.success) {
                    const data = netIncomeData.data;
                    document.getElementById('totalIncome').innerHTML = `<span class="animate-fadeIn">${formatCurrency(data.total_income)}</span>`;
                    document.getElementById('totalExpenses').innerHTML = `<span class="animate-fadeIn">${formatCurrency(data.total_expenses)}</span>`;
                    document.getElementById('netIncome').innerHTML = `<span class="animate-fadeIn">${formatCurrency(data.net_income)}</span>`;
                    
                    // Update trend indicators (mock data for now)
                    updateTrendIndicators(data);
                    
                    // Create income vs expense chart
                    createIncomeExpenseChart(data);
                    
                    // Check for discrepancy between registrations and payments
                    if (data.has_discrepancy) {
                        const discrepancy = data.income_discrepancy;
                        notify._showSnackbar(
                            `Ø§Ø®Ø·Ø§Ø±: Ø§Ø®ØªÙ„Ø§Ù Ø¨ÛŒÙ† Ø¯Ø±Ø¢Ù…Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§: ${formatCurrency(Math.abs(discrepancy))}`,
                            'warning'
                        );
                    }
                } else {
                    // Show error state in summary cards
                    const errorMsg = netIncomeData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯';
                    showSummaryError(errorMsg);
                    notify.error(errorMsg);
                }

                await new Promise(resolve => setTimeout(resolve, 300));

                // Step 3: Coach Payments
                updateProgressStep(2, 'completed');
                updateProgressStep(3, 'active');
                updateProgressText('Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†...');

                // Load payouts
                const payoutsData = await APIClient.get(`accounting.php?action=payouts&month=${month}&year=${year}`);
                if (payoutsData.success) {
                    const tbody = document.getElementById('payoutsTableBody');
                    const data = payoutsData.data;
                    
                    // Create charts with payout data
                    createCoachPaymentsChart(data.payouts);
                    createIncomeDistributionChart(data);
                    
                    // Update camp summary section
                    document.getElementById('summaryTotalFees').textContent = formatCurrency(data.total_student_fees);
                    document.getElementById('summaryCoachPayments').textContent = formatCurrency(data.total_coach_payments);
                    document.getElementById('summaryExpenses').textContent = formatCurrency(data.total_expenses);
                    const campNet = document.getElementById('summaryCampNet');
                    campNet.textContent = formatCurrency(data.camp_net_income);
                    campNet.className = 'fs-4 fw-bold ' + (data.camp_net_income >= 0 ? 'text-success' : 'text-danger');
                    
                    if (data.payouts.length === 0) {
                        tbody.innerHTML = `
                            <tr><td colspan="6">
                                <div class="text-center py-5 animate-fadeIn">
                                    <div style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;">ğŸ‘¤</div>
                                    <div class="text-muted">Ù…Ø±Ø¨ÛŒ ÙØ¹Ø§Ù„ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
                                </div>
                            </td></tr>
                        `;
                    } else {
                        // Calculate totals for footer row
                        const totals = data.payouts.reduce((acc, p) => ({
                            totalFees: acc.totalFees + p.total_fees_collected,
                            eligibleFees: acc.eligibleFees + p.eligible_fees,
                            payments: acc.payments + p.calculated_payment
                        }), { totalFees: 0, eligibleFees: 0, payments: 0 });
                        
                        const rows = data.payouts.map((payout, index) => `
                            <tr class="animate-slideUp" style="animation-delay: ${index * 50}ms;">
                                <td>
                                    <span class="coach-name">${payout.coach_name}</span>
                                </td>
                                <td>
                                    <span class="badge" style="background: ${getContractTypeBadgeColor(payout.contract_type)}; font-size: 11px;">
                                        ${payout.contract_type_label}
                                    </span>
                                    ${payout.contract_type === 'percentage' || payout.contract_type === 'hybrid' 
                                        ? `<small class="text-muted d-block">${payout.percentage_rate}%</small>` 
                                        : ''}
                                </td>
                                <td>${formatCurrency(payout.total_fees_collected)}</td>
                                <td>
                                    ${formatCurrency(payout.eligible_fees)}
                                    <small class="text-muted d-block" style="font-size: 10px;">
                                        ${payout.fee_calculation_slots === 'morning_evening' ? 'ØµØ¨Ø­/Ø´Ø§Ù…' : 
                                          payout.fee_calculation_slots === 'all' ? 'Ù‡Ù…Ù‡' : 'Ø³ÙØ§Ø±Ø´ÛŒ'}
                                    </small>
                                </td>
                                <td>
                                    <span class="payout-total">${formatCurrency(payout.calculated_payment)}</span>
                                    <button class="btn-link p-0 ms-1" style="border: none; background: none; cursor: pointer;" 
                                            onclick="toggleCalculation(${index})" title="Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡">
                                        <i class="bi bi-info-circle text-primary"></i>
                                    </button>
                                </td>
                                <td>
                                    <button class="btn-app btn-app--primary btn-app--sm" onclick="viewCoachTransactions(${payout.coach_id})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr class="calculation-row" id="calc-row-${index}" style="display: none;">
                                <td colspan="6" style="background: var(--bg-secondary); padding: 12px 20px;">
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        <strong><i class="bi bi-calculator me-1"></i>Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡:</strong>
                                        <div style="margin-top: 8px; direction: ltr; text-align: left; font-family: monospace;">
                                            ${payout.calculation_breakdown || 'Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                        
                        // Add total footer row
                        const footerRow = `
                            <tr class="animate-slideUp" style="background: var(--bg-secondary); font-weight: bold; border-top: 2px solid var(--border-color); animation-delay: ${data.payouts.length * 50}ms;">
                                <td colspan="2" style="text-align: right;">Ù…Ø¬Ù…ÙˆØ¹</td>
                                <td>${formatCurrency(totals.totalFees)}</td>
                                <td>${formatCurrency(totals.eligibleFees)}</td>
                                <td><span class="payout-total">${formatCurrency(totals.payments)}</span></td>
                                <td></td>
                            </tr>
                        `;
                        
                        tbody.innerHTML = rows + footerRow;
                    }
                } else {
                    // Show error state in payouts table
                    const errorMsg = payoutsData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÛŒØ§Ù†';
                    showTableError(errorMsg);
                    notify.error(errorMsg);
                }

                await new Promise(resolve => setTimeout(resolve, 300));

                // Step 4: Complete
                updateProgressStep(3, 'completed');
                updateProgressStep(4, 'active');
                updateProgressText('ØªÚ©Ù…ÛŒÙ„ Ú¯Ø²Ø§Ø±Ø´...');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgressStep(4, 'completed');
                updateProgressText('Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ‡ÛŒÙ‡ Ø´Ø¯');
                
                // Hide progress after delay
                setTimeout(() => {
                    hideCalculationProgress();
                }, 1500);

            } catch (error) {
                // Log error for debugging (Task 11)
                console.error('Accounting load error:', error);
                
                // Determine appropriate error message
                let errorMsg = 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡';
                if (!navigator.onLine) {
                    errorMsg = 'Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª';
                } else if (error && error.message) {
                    errorMsg = 'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±: ' + error.message;
                }
                
                // Show error state in all elements
                showSummaryError(errorMsg);
                showTableError(errorMsg);
                hideCalculationProgress();
                notify.error(errorMsg);
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-calculator"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†';
            }
        }

        // Enhanced loading state functions
        function showCalculationProgress() {
            const progress = document.getElementById('calculationProgress');
            progress.classList.add('show');
            
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
            
            // Destroy existing charts during loading
            destroyAllCharts();
        }

        function hideCalculationProgress() {
            const progress = document.getElementById('calculationProgress');
            progress.classList.remove('show');
        }

        function updateProgressStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.classList.remove('active', 'completed');
            if (status) {
                step.classList.add(status);
            }
        }

        function updateProgressText(text) {
            document.getElementById('progressText').textContent = text;
        }

        function showSummarySkeletons() {
            document.getElementById('totalIncome').innerHTML = '<div class="skeleton" style="width: 120px; height: 36px;"></div>';
            document.getElementById('totalExpenses').innerHTML = '<div class="skeleton" style="width: 120px; height: 36px;"></div>';
            document.getElementById('netIncome').innerHTML = '<div class="skeleton" style="width: 120px; height: 36px;"></div>';
            
            // Show skeleton for trend indicators
            document.getElementById('incomeTrend').innerHTML = '<div class="skeleton" style="width: 80px; height: 20px;"></div>';
            document.getElementById('expenseTrend').innerHTML = '<div class="skeleton" style="width: 80px; height: 20px;"></div>';
            document.getElementById('netTrend').innerHTML = '<div class="skeleton" style="width: 80px; height: 20px;"></div>';
        }

        function showSummaryError(errorMsg) {
            document.getElementById('totalIncome').innerHTML = '<span class="text-danger">Ø®Ø·Ø§</span>';
            document.getElementById('totalExpenses').innerHTML = '<span class="text-danger">Ø®Ø·Ø§</span>';
            document.getElementById('netIncome').innerHTML = '<span class="text-danger">Ø®Ø·Ø§</span>';
            
            // Clear trend indicators
            document.getElementById('incomeTrend').innerHTML = '';
            document.getElementById('expenseTrend').innerHTML = '';
            document.getElementById('netTrend').innerHTML = '';
        }

        // Chart creation functions
        function createIncomeExpenseChart(data) {
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.incomeExpense) {
                charts.incomeExpense.destroy();
            }
            
            charts.incomeExpense = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„', 'Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„', 'Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù„Øµ'],
                    datasets: [{
                        data: [data.total_income, data.total_expenses, data.net_income],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',  // Green for income
                            'rgba(239, 68, 68, 0.8)',   // Red for expenses
                            'rgba(59, 130, 246, 0.8)'   // Blue for net
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(59, 130, 246, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y) + ' ØªÙˆÙ…Ø§Ù†';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Update chart statistics
            const profitMargin = data.total_income > 0 ? ((data.net_income / data.total_income) * 100).toFixed(1) : '0';
            const expenseRatio = data.total_income > 0 ? ((data.total_expenses / data.total_income) * 100).toFixed(1) : '0';
            
            document.getElementById('profitMargin').textContent = profitMargin + '%';
            document.getElementById('expenseRatio').textContent = expenseRatio + '%';
        }

        function createCoachPaymentsChart(payouts) {
            const ctx = document.getElementById('coachPaymentsChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.coachPayments) {
                charts.coachPayments.destroy();
            }
            
            if (!payouts || payouts.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px IRANSans';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const labels = payouts.map(p => p.coach_name);
            const payments = payouts.map(p => p.calculated_payment);
            const colors = payouts.map((_, index) => {
                const hue = (index * 137.508) % 360; // Golden angle approximation
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            
            charts.coachPayments = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: payments,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.x) + ' ØªÙˆÙ…Ø§Ù†';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Update coach payment statistics
            const totalPayments = payments.reduce((sum, payment) => sum + payment, 0);
            const avgPayment = totalPayments / payments.length;
            const efficiency = totalPayments > 0 ? ((totalPayments / (totalPayments * 1.2)) * 100).toFixed(1) : '0'; // Mock efficiency calculation
            
            document.getElementById('avgCoachPayment').textContent = formatCurrency(avgPayment);
            document.getElementById('totalCoaches').textContent = payouts.length;
            document.getElementById('paymentEfficiency').textContent = efficiency + '%';
        }

        function createIncomeDistributionChart(data) {
            const ctx = document.getElementById('incomeDistributionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.incomeDistribution) {
                charts.incomeDistribution.destroy();
            }
            
            // Create mock distribution data (you can replace with real data from API)
            const distributionData = [
                { label: 'Ø´Ù‡Ø±ÛŒÙ‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†', value: data.total_student_fees, color: '#10b981' },
                { label: 'Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ø¶Ø§ÙÛŒ', value: Math.max(0, data.total_student_fees * 0.1), color: '#6366f1' },
                { label: 'Ø³Ø§ÛŒØ± Ø¯Ø±Ø¢Ù…Ø¯Ù‡Ø§', value: Math.max(0, data.total_student_fees * 0.05), color: '#f59e0b' }
            ];
            
            const labels = distributionData.map(item => item.label);
            const values = distributionData.map(item => item.value);
            const colors = distributionData.map(item => item.color);
            
            charts.incomeDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Update legend
            const legendContainer = document.getElementById('incomeDistributionLegend');
            legendContainer.innerHTML = distributionData.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${item.color};"></div>
                    <span>${item.label}</span>
                </div>
            `).join('');
        }

        function updateTrendIndicators(data) {
            // Mock trend data (you can replace with real historical comparison)
            const trends = {
                income: Math.random() > 0.5 ? 'positive' : 'negative',
                expense: Math.random() > 0.5 ? 'positive' : 'negative',
                net: data.net_income >= 0 ? 'positive' : 'negative'
            };
            
            const trendPercentages = {
                income: (Math.random() * 20).toFixed(1),
                expense: (Math.random() * 15).toFixed(1),
                net: (Math.random() * 25).toFixed(1)
            };
            
            // Update trend indicators
            document.getElementById('incomeTrend').innerHTML = `
                <span class="trend-indicator ${trends.income}">
                    <i class="bi bi-arrow-${trends.income === 'positive' ? 'up' : 'down'}"></i>
                    ${trendPercentages.income}%
                </span>
            `;
            
            document.getElementById('expenseTrend').innerHTML = `
                <span class="trend-indicator ${trends.expense}">
                    <i class="bi bi-arrow-${trends.expense === 'positive' ? 'up' : 'down'}"></i>
                    ${trendPercentages.expense}%
                </span>
            `;
            
            document.getElementById('netTrend').innerHTML = `
                <span class="trend-indicator ${trends.net}">
                    <i class="bi bi-arrow-${trends.net === 'positive' ? 'up' : 'down'}"></i>
                    ${trendPercentages.net}%
                </span>
            `;
        }

        // Cleanup function to destroy all charts
        function destroyAllCharts() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
        }

        function showTableSkeletons() {
            const tbody = document.getElementById('payoutsTableBody');
            tbody.innerHTML = `
                <tr class="table-skeleton">
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text long"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                </tr>
                <tr class="table-skeleton">
                    <td><div class="skeleton-text long"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                </tr>
                <tr class="table-skeleton">
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                    <td><div class="skeleton-text long"></div></td>
                    <td><div class="skeleton-text medium"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                    <td><div class="skeleton-text short"></div></td>
                </tr>
            `;
        }

        function showTableError(errorMsg) {
            document.getElementById('payoutsTableBody').innerHTML = `
                <tr><td colspan="6">
                    <div class="text-center py-5 animate-fadeIn">
                        <div style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;">âš ï¸</div>
                        <div class="text-danger">${errorMsg}</div>
                        <button class="btn-app btn-app--outline btn-app--sm mt-3" onclick="loadAccounting()">
                            <i class="bi bi-arrow-clockwise"></i> ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
                        </button>
                    </div>
                </td></tr>
            `;
        }

        function toggleCalculation(index) {
            const row = document.getElementById(`calc-row-${index}`);
            if (row) {
                row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        function showBreakdown(type) {
            if (!currentMonth || !currentYear) {
                notify._showSnackbar('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
                return;
            }
            window.open(`breakdown.html?type=${type}&month=${currentMonth}&year=${currentYear}`, '_blank');
        }

        function viewCoachTransactions(coachId) {
            if (!currentMonth || !currentYear) return;
            window.open(`breakdown.html?type=coach&id=${coachId}&month=${currentMonth}&year=${currentYear}`, '_blank');
        }

        // Mobile sidebar toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
        }

        initDarkMode();
        
        // Set current Jalali year as default
        document.addEventListener('DOMContentLoaded', function() {
            const yearSelect = document.getElementById('yearSelect');
            if (yearSelect && typeof getCurrentJalaliYear === 'function') {
                yearSelect.value = getCurrentJalaliYear();
            }
        });
    </script>
</body>
</html>
